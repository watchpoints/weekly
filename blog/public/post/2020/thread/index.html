<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>å¤šè¿›ç¨‹å¤šçº¿ç¨‹ç¯‡ - Troyçš„ç½‘ç»œåšå®¢</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Troy" /><meta name="description" content="è¿™é‡Œä¸»è¦è®°å½•å­¦ä¹ å’Œæ¢ç´¢è¿‡ç¨‹ã€‚æ¥éªŒè¯æ­£ç¡®æ–¹æ³•æ‰èƒ½æœ‰æ­£ç¡®çš„ç»“æœã€‚ èµ°ç¥ä¸€ä¼š ä½ æ‰€å¯»æ‰¾çš„ä¸œè¥¿æ­£åœ¨å¯»æ‰¾ä½ ã€‚-é²ç±³ What you seek is seeking you. ä½ ç”Ÿæ¥å°±æœ‰ä¸€å¯¹ç¿…è†€ã€‚ä¸ºä»€ä¹ˆæ›´" /><meta name="keywords" content="daily-interview-question, Github, c&#43;&#43;, Leetcode é¢˜è§£, åç«¯é¢è¯•" />






<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="https://wangcy6.github.io/post/2020/thread/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="å¤šè¿›ç¨‹å¤šçº¿ç¨‹ç¯‡" />
<meta property="og:description" content="è¿™é‡Œä¸»è¦è®°å½•å­¦ä¹ å’Œæ¢ç´¢è¿‡ç¨‹ã€‚æ¥éªŒè¯æ­£ç¡®æ–¹æ³•æ‰èƒ½æœ‰æ­£ç¡®çš„ç»“æœã€‚ èµ°ç¥ä¸€ä¼š ä½ æ‰€å¯»æ‰¾çš„ä¸œè¥¿æ­£åœ¨å¯»æ‰¾ä½ ã€‚-é²ç±³ What you seek is seeking you. ä½ ç”Ÿæ¥å°±æœ‰ä¸€å¯¹ç¿…è†€ã€‚ä¸ºä»€ä¹ˆæ›´" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wangcy6.github.io/post/2020/thread/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-11-29T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2019-11-29T00:00:00&#43;00:00" />

<meta itemprop="name" content="å¤šè¿›ç¨‹å¤šçº¿ç¨‹ç¯‡">
<meta itemprop="description" content="è¿™é‡Œä¸»è¦è®°å½•å­¦ä¹ å’Œæ¢ç´¢è¿‡ç¨‹ã€‚æ¥éªŒè¯æ­£ç¡®æ–¹æ³•æ‰èƒ½æœ‰æ­£ç¡®çš„ç»“æœã€‚ èµ°ç¥ä¸€ä¼š ä½ æ‰€å¯»æ‰¾çš„ä¸œè¥¿æ­£åœ¨å¯»æ‰¾ä½ ã€‚-é²ç±³ What you seek is seeking you. ä½ ç”Ÿæ¥å°±æœ‰ä¸€å¯¹ç¿…è†€ã€‚ä¸ºä»€ä¹ˆæ›´"><meta itemprop="datePublished" content="2019-11-29T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-11-29T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3277">
<meta itemprop="keywords" content="book," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="å¤šè¿›ç¨‹å¤šçº¿ç¨‹ç¯‡"/>
<meta name="twitter:description" content="è¿™é‡Œä¸»è¦è®°å½•å­¦ä¹ å’Œæ¢ç´¢è¿‡ç¨‹ã€‚æ¥éªŒè¯æ­£ç¡®æ–¹æ³•æ‰èƒ½æœ‰æ­£ç¡®çš„ç»“æœã€‚ èµ°ç¥ä¸€ä¼š ä½ æ‰€å¯»æ‰¾çš„ä¸œè¥¿æ­£åœ¨å¯»æ‰¾ä½ ã€‚-é²ç±³ What you seek is seeking you. ä½ ç”Ÿæ¥å°±æœ‰ä¸€å¯¹ç¿…è†€ã€‚ä¸ºä»€ä¹ˆæ›´"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">é¦–é¡µ</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">å½’æ¡£</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">åˆ†ç±»</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="https://github.com/wangcy6/weekly/tree/master/book">
        <li class="mobile-menu-item">é˜…è¯»æ¸…å•</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">å…³äºæˆ‘</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">é¦–é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">å½’æ¡£</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">åˆ†ç±»</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://github.com/wangcy6/weekly/tree/master/book">é˜…è¯»æ¸…å•</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">å…³äºæˆ‘</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">å¤šè¿›ç¨‹å¤šçº¿ç¨‹ç¯‡</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-11-29 00:00 </span>
        <div class="post-category">
            <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/"> æ“ä½œç³»ç»ŸåŸç† </a>
            </div>
          <span class="more-meta"> çº¦ 3277 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 7 åˆ†é’Ÿ </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡é˜…è¯» </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#çº¿ç¨‹">çº¿ç¨‹</a>
      <ul>
        <li><a href="#1--çº¿ç¨‹çš„åˆ›å»ºè¿‡ç¨‹">1.  çº¿ç¨‹çš„åˆ›å»ºè¿‡ç¨‹</a></li>
        <li><a href="#2-çº¿ç¨‹çš„é”€æ¯è¿‡ç¨‹">2. çº¿ç¨‹çš„é”€æ¯è¿‡ç¨‹</a></li>
        <li><a href="#3çº¿ç¨‹å®‰å…¨">3.çº¿ç¨‹å®‰å…¨</a></li>
      </ul>
    </li>
    <li><a href="#è¿›ç¨‹">è¿›ç¨‹</a>
      <ul>
        <li><a href="#ä¸€-è¿›ç¨‹åˆ›å»ºæ–¹å¼">ä¸€. è¿›ç¨‹åˆ›å»ºæ–¹å¼</a></li>
        <li><a href="#ä¸ºä»€ä¹ˆclose_on_execä¸æ˜¯é»˜è®¤é…ç½®httpswwwthinbugcomq9583845"><a href="https://www.thinbug.com/q/9583845">ä¸ºä»€ä¹ˆclose_on_execä¸æ˜¯é»˜è®¤é…ç½®ï¼Ÿ</a></a></li>
        <li><a href="#äºŒ-è¿›ç¨‹çš„é”€æ¯">äºŒã€ è¿›ç¨‹çš„é”€æ¯</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>ã€æ³¨æ„ã€‘æœ€åæ›´æ–°äº <span class="timeago" datetime="2019-11-29T00:00:00" title="November 29, 2019">November 29, 2019</span>ï¼Œæ–‡ä¸­å†…å®¹å¯èƒ½å·²è¿‡æ—¶ï¼Œè¯·è°¨æ…ä½¿ç”¨ã€‚</p>
    </div>
  </div>
    <div class="post-content">
      <blockquote>
<p>è¿™é‡Œä¸»è¦è®°å½•å­¦ä¹ å’Œæ¢ç´¢è¿‡ç¨‹ã€‚æ¥éªŒè¯æ­£ç¡®æ–¹æ³•æ‰èƒ½æœ‰æ­£ç¡®çš„ç»“æœã€‚</p>
</blockquote>
<h1 id="èµ°ç¥ä¸€ä¼š">èµ°ç¥ä¸€ä¼š</h1>
<p><strong>ä½ æ‰€å¯»æ‰¾çš„ä¸œè¥¿æ­£åœ¨å¯»æ‰¾ä½ ã€‚-é²ç±³</strong></p>
<p>What you seek is seeking you.</p>
<p><strong>ä½ ç”Ÿæ¥å°±æœ‰ä¸€å¯¹ç¿…è†€ã€‚ä¸ºä»€ä¹ˆæ›´å–œæ¬¢ä¸€è¾¹çˆ¬è¡Œä¸€è¾¹ç”Ÿæ´»ï¼Ÿâ€“ é²ç±³</strong></p>
<p>You were born with wings. Why prefer to crawl through life?</p>
<p><strong>ä½ ä¸æ˜¯ä¸€æ»´æ°´åœ¨æµ·æ´‹ä¸­ã€‚ä½ æ˜¯æ•´ä¸ªæµ·æ´‹åœ¨ä¸€æ»´æ°´ä¸­ã€‚ â€“ é²ç±³</strong></p>
<p>You are not a drop in the ocean. You are the entire ocean in a drop.</p>
<p><strong>åœ¨ä½ çš„æé—®ä¸­å¯»æ‰¾ç­”æ¡ˆã€‚-é²ç±³</strong></p>
<p>Look for the answer inside your question.</p>
<h1 id="book">book</h1>
<p><img src="https://i.loli.net/2019/11/30/7jliopUsPdcItS8.png" alt="image.png"></p>
<h1 id="çŸ¥è¯†å›¾è°±">çŸ¥è¯†å›¾è°±</h1>
<h2 id="çº¿ç¨‹">çº¿ç¨‹</h2>
<h3 id="1--çº¿ç¨‹çš„åˆ›å»ºè¿‡ç¨‹">1.  çº¿ç¨‹çš„åˆ›å»ºè¿‡ç¨‹</h3>
<p>pthread_atfork å‡½æ•°è§£å†³å¤šçº¿ç¨‹å¤šè¿›ç¨‹æ­»é”é—®é¢˜</p>
<blockquote>
<p>With pthread_atfork, we can install up to three functions to help clean up the
locks.</p>
<p>pthread_atfork()åœ¨<code>fork()ä¹‹å‰</code>è°ƒç”¨ã€‚</p>
<p>å½“è°ƒç”¨forkæ—¶ï¼Œå†…éƒ¨<code>åˆ›å»ºå­è¿›ç¨‹å‰</code>åœ¨çˆ¶è¿›ç¨‹ä¸­ä¼šè°ƒç”¨prepareï¼Œå†…éƒ¨<code>åˆ›å»ºå­è¿›ç¨‹æˆåŠŸå</code>ï¼Œçˆ¶è¿›ç¨‹ä¼šè°ƒç”¨parent ï¼Œå­è¿›ç¨‹ä¼šè°ƒç”¨childã€‚</p>
</blockquote>
<h3 id="2-çº¿ç¨‹çš„é”€æ¯è¿‡ç¨‹">2. çº¿ç¨‹çš„é”€æ¯è¿‡ç¨‹</h3>
<blockquote>
<p>é—®é¢˜ 1 ä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ join ï¼Œä»€ä¹ˆåœºæ™¯ä¸‹ä½¿ç”¨ detach ?</p>
</blockquote>
<p>Detaching is not a no-no. Itâ€™s legal, a lot of high-quality production code have it,</p>
<p>it just might be <strong>dangerous</strong>. (ä¸€æ–¹é¢æå€¡ä½¿ç”¨ï¼Œä¸€æ–¹é¢è¯´å±é™©ï¼Œå“ªé‡Œå±é™©äº†ï¼Œç»™å‡ºä¸‰ä¸ªä¾‹å­ï¼Œå› ä¸ºå·¥ä½œçº¿ç¨‹æ— è®ºæ˜¯ç®€å•ä¸šåŠ¡é€»è¾‘è¿˜æ˜¯å¼‚æ­¥å¤„ç† æ‰§è¡Œæ—¶é—´åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ˜¯ä¸å¯é¢„ä¼°çš„ã€‚ä¸€åˆ‡æ— æ³•æ§åˆ¶çš„ï¼Œè¿™å¤šçº¿ç¨‹å±é™©)</p>
<p>So, think carefully when choosing between join and detach.</p>
<p>Whether an <code>std::thread</code> object <strong>is</strong> or <strong>is not</strong> <em>joinable</em> determines whether you <strong>may</strong> or <strong>may not</strong> <em>join</em> or <em>detach</em> it.</p>
<p>it up to you</p>
<p>it up to you</p>
<p>ï¼ˆæˆ‘å“ªé‡ŒçŸ¥é“ï¼Ÿï¼Ÿï¼‰</p>
<blockquote>
<p>å°ç‹ï¼šç¬¬ä¸€æ¬¡å°è¯•å›ç­”</p>
</blockquote>
<ul>
<li>
<p>If at any point the object is <em>joined</em> (by calling <code>*join()*</code>), the parent thread will wait there for the child to complete its job.</p>
</li>
<li>
<p>If itâ€™s <em>detached</em> (by calling <code>*detach()*</code>), it will keep running in the background and the parent thread wonâ€™t wait for it to finish.</p>
</li>
</ul>
<blockquote>
<p>è€ç‹ï¼šä¸æ‡‚ ä¸æ‡‚ ä¸æ‡‚ï¼Œæˆ‘é—®ä»€ä¹ˆæ—¶å€™è¯¥è®¾ç½® join /detachï¼Œä»€ä¹ˆæ—¶å€™ä¸è¯¥ä»€ä¹ˆè®¾ç½®join /detachï¼Œ</p>
<p>ä½ å›ç­”ç”¨æ³•.ä¸ç¬¦åˆé¢˜ç›®è¦æ±‚ï¼Œä½ è€ƒè™‘ä¸‹mainå‡½æ•°æ˜¯å¦‚ä½•ç¦»å¼€çš„ï¼Ÿ</p>
</blockquote>
<p>This answer is aimed at answering question in the titleï¼ˆ when should <code>std:ğŸ§µ:detach</code> should be used? ï¼‰, rather than explaining the difference between <code>join</code> and <code>detach</code>.</p>
<blockquote>
<p>å°ç‹ä¸€å¤´é›¾æ°´ï¼Œè¡¨ç¤º è¿˜èƒ½æ€ä¹ˆåˆ†æï¼Œæ²¡æœ‰æ€è·¯,</p>
</blockquote>
<h5 id="man-pthread_detach">man pthread_detach</h5>
<p><a href="http://man7.org/linux/man-pages/man3/pthread_detach.3.html">http://man7.org/linux/man-pages/man3/pthread_detach.3.html</a></p>
<p><img src="https://i.loli.net/2019/11/30/R38sZjhMDom4ULn.png" alt="man"></p>
<p>The detached attribute merely determines the behavior of the system when the thread terminates; it does not prevent the thread from being terminated</p>
<p>if  the process terminates <strong>using exit(3) (or equivalently, if the main thread returns).</strong></p>
<p>ä¸€ä¸ªçº¿ç¨‹å¼‚å¸¸ï¼Œæ•´ä¸ªè¿›ç¨‹é€€å‡ºï¼ˆæ­£ç¡®ï¼‰</p>
<p>ä¸€ä¸ªçº¿ç¨‹é€€å‡ºï¼Œæ•´ä¸ªè¿›ç¨‹ç»“æŸï¼ˆé”™è¯¯ï¼‰</p>
<p>ä¸»è¿›ç¨‹é€€å‡ºï¼Œæ•´ä¸ªè¿›ç¨‹ç»“æŸï¼ˆæ­£ç¡®ï¼‰</p>
<p>mainå‡½æ•°éƒ½é€€å‡ºäº†ï¼Œæ•´ä¸ªè¿›ç¨‹ç©ºé—´éƒ½æ¶ˆå¤±äº†ï¼Œä¸ç®¡ä»€ä¹ˆæ ·æ–¹å¼è¿›ç¨‹ éƒ½ä¼šåˆ«è¢«é”€æ¯çš„ã€‚</p>
<p>ä¸ºå·¥ä½œçº¿ç¨‹æ‰§è¡Œæ—¶é—´é•¿çŸ­ä¸ç¡®å®šï¼ˆå³ä½¿éé˜»å¡ï¼Œæˆ–è€…sleep æ¥æ§åˆ¶ï¼Œè¿˜æœ‰cpuè°ƒåº¦å› ç´ è€ƒè™‘ï¼‰</p>
<p>è¿™å°±æ˜¯æˆ‘ç†è§£å¿…é¡»é€šè¿‡joinæ–¹å¼é˜»å¡mainçº¿ç¨‹ã€‚</p>
<h5 id="man-pthread_exit">man pthread_exit</h5>
<p>åœ¨notes æœ€é‡è¦çš„ä¸€å¥è¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">To</span> <span class="n">allow</span> <span class="n">other</span> <span class="n">threads</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">execution</span><span class="p">,</span> 
<span class="n">the</span> <span class="n">main</span> <span class="kr">thread</span> <span class="n">should</span> <span class="n">terminate</span> <span class="n">by</span> <span class="n">calling</span> <span class="n">pthread_exit</span><span class="p">()</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span>
</code></pre></td></tr></table>
</div>
</div><p>è§£é‡Šï¼š</p>
<ul>
<li>
<p>pthread_exit ä½œç”¨å°±æ˜¯åªç»ˆæ­¢è°ƒç”¨çº¿ç¨‹ï¼Œå°±æ˜¯è‡ªå·±(è¿™ä¸ªæˆ‘çŸ¥é“äº†ï¼Œexitå°±æ˜¯æ¨å‡º)</p>
</li>
<li>
<p>pthread_exit åªæ¸…æ¥šè‡ªå·±çš„æ•°æ®(è¿™ä¸ªæˆ‘çŸ¥é“äº†ï¼Œexitå°±æ˜¯æ¨å‡º)</p>
</li>
<li>
<p>pthread_exit ä¸æ¸…ç†å…¨å±€å…±äº«çš„æ•°æ®ï¼Œé€šè¿‡atexit()æ–¹å¼æ³¨å†Œçš„é”€æ¯æ•°æ®æ–¹å¼ï¼Œä¸è¢«æ‰§è¡Œï¼ˆatexitæ˜¯è¿›ç¨‹é€€å‡ºæ‰§è¡Œï¼‰</p>
</li>
<li>
<p>å¦‚æœç»ˆæ­¢æ˜¯æœ€åä¸€ä¸ªçº¿ç¨‹ã€‚çœŸä¸ªè¿›ç¨‹è°ƒç”¨exité€€å‡ºï¼Œé”€æ¯æ•´ä¸ªè¿›ç¨‹ã€‚</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"> <span class="nl">http</span><span class="p">:</span><span class="c1">//man7.org/linux/man-pages/man3/pthread_exit.3.html 
</span><span class="c1"></span><span class="n">NAME</span>  
       <span class="kt">void</span> <span class="n">pthread_exit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">retval</span><span class="p">);</span>
<span class="n">DESCRIPTION</span>        
    
       <span class="n">The</span> <span class="nf">pthread_exit</span><span class="p">()</span> <span class="n">function</span> <span class="n">terminates</span> <span class="n">the</span> <span class="n">calling</span> <span class="kr">thread</span> <span class="n">and</span> <span class="n">returns</span>
       <span class="n">a</span> <span class="n">value</span> <span class="n">via</span> <span class="n">retval</span> <span class="n">that</span> <span class="p">(</span><span class="k">if</span> <span class="n">the</span> <span class="kr">thread</span> <span class="n">is</span> <span class="n">joinable</span><span class="p">)</span> <span class="n">is</span> <span class="n">available</span> <span class="n">to</span>
       <span class="n">another</span> <span class="kr">thread</span> <span class="n">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">process</span> <span class="n">that</span> <span class="n">calls</span> <span class="n">pthread_join</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span>

       <span class="n">Any</span> <span class="n">clean</span><span class="o">-</span><span class="n">up</span> <span class="n">handlers</span> <span class="n">established</span> <span class="n">by</span> <span class="n">pthread_cleanup_push</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="n">that</span>
       <span class="n">have</span> <span class="n">not</span> <span class="n">yet</span> <span class="n">been</span> <span class="n">popped</span><span class="p">,</span> <span class="n">are</span> <span class="n">popped</span> <span class="p">(</span><span class="n">in</span> <span class="n">the</span> <span class="n">reverse</span> <span class="n">of</span> <span class="n">the</span> <span class="n">order</span> <span class="n">in</span>
       <span class="n">which</span> <span class="n">they</span> <span class="n">were</span> <span class="n">pushed</span><span class="p">)</span> <span class="n">and</span> <span class="n">executed</span><span class="p">.</span>  <span class="n">If</span> <span class="n">the</span> <span class="kr">thread</span> <span class="n">has</span> <span class="n">any</span> <span class="kr">thread</span><span class="o">-</span>
       <span class="n">specific</span> <span class="n">data</span><span class="p">,</span> <span class="n">then</span><span class="p">,</span> <span class="n">after</span> <span class="n">the</span> <span class="n">clean</span><span class="o">-</span><span class="n">up</span> <span class="n">handlers</span> <span class="n">have</span> <span class="n">been</span> <span class="n">executed</span><span class="p">,</span>
       <span class="n">the</span> <span class="n">corresponding</span> <span class="n">destructor</span> <span class="n">functions</span> <span class="n">are</span> <span class="n">called</span><span class="p">,</span> <span class="n">in</span> <span class="n">an</span> <span class="n">unspecified</span>
       <span class="n">order</span><span class="p">.</span>

       <span class="n">When</span> <span class="n">a</span> <span class="kr">thread</span> <span class="n">terminates</span><span class="p">,</span> <span class="n">process</span><span class="o">-</span><span class="n">shared</span> <span class="n">resources</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">g</span><span class="p">.,</span> <span class="n">mutexes</span><span class="p">,</span>
       <span class="n">condition</span> <span class="n">variables</span><span class="p">,</span> <span class="n">semaphores</span><span class="p">,</span> <span class="n">and</span> <span class="n">file</span> <span class="n">descriptors</span><span class="p">)</span> <span class="n">are</span> <span class="n">not</span>
       <span class="n">released</span><span class="p">,</span> <span class="n">and</span> <span class="n">functions</span> <span class="n">registered</span> <span class="n">using</span> <span class="n">atexit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="n">are</span> <span class="n">not</span> <span class="n">called</span><span class="p">.</span>

       <span class="n">After</span> <span class="n">the</span> <span class="n">last</span> <span class="kr">thread</span> <span class="n">in</span> <span class="n">a</span> <span class="n">process</span> <span class="n">terminates</span><span class="p">,</span> <span class="n">the</span> <span class="n">process</span> <span class="n">terminates</span>
       <span class="n">as</span> <span class="n">by</span> <span class="n">calling</span> <span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="n">with</span> <span class="n">an</span> <span class="n">exit</span> <span class="n">status</span> <span class="n">of</span> <span class="n">zero</span><span class="p">;</span> <span class="n">thus</span><span class="p">,</span> <span class="n">process</span><span class="o">-</span>
       <span class="n">shared</span> <span class="n">resources</span> <span class="n">are</span> <span class="n">releas</span>
  <span class="n">NOTES</span>       
           
       <span class="n">Performing</span> <span class="n">a</span> <span class="k">return</span> <span class="n">from</span> <span class="n">the</span> <span class="n">start</span> <span class="n">function</span> <span class="n">of</span> <span class="n">any</span> <span class="kr">thread</span> <span class="n">other</span> <span class="n">than</span>
       <span class="n">the</span> <span class="n">main</span> <span class="kr">thread</span> <span class="n">results</span> <span class="n">in</span> <span class="n">an</span> <span class="n">implicit</span> <span class="n">call</span> <span class="n">to</span> <span class="n">pthread_exit</span><span class="p">(),</span> <span class="n">using</span>
       <span class="n">the</span> <span class="n">function</span><span class="err">&#39;</span><span class="n">s</span> <span class="k">return</span> <span class="n">value</span> <span class="n">as</span> <span class="n">the</span> <span class="kr">thread</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">exit</span> <span class="n">status</span><span class="p">.</span>

       <span class="n">To</span> <span class="n">allow</span> <span class="n">other</span> <span class="n">threads</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">execution</span><span class="p">,</span> <span class="n">the</span> <span class="n">main</span> <span class="kr">thread</span> <span class="n">should</span>
       <span class="n">terminate</span> <span class="n">by</span> <span class="n">calling</span> <span class="n">pthread_exit</span><span class="p">()</span> <span class="n">rather</span> <span class="n">than</span> <span class="n">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span>

       <span class="n">The</span> <span class="n">value</span> <span class="n">pointed</span> <span class="n">to</span> <span class="n">by</span> <span class="n">retval</span> <span class="n">should</span> <span class="n">not</span> <span class="n">be</span> <span class="n">located</span> <span class="n">on</span> <span class="n">the</span> <span class="n">calling</span>
       <span class="kr">thread</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">stack</span><span class="p">,</span> <span class="n">since</span> <span class="n">the</span> <span class="n">contents</span> <span class="n">of</span> <span class="n">that</span> <span class="n">stack</span> <span class="n">are</span> <span class="n">undefined</span> <span class="n">after</span>
       <span class="n">the</span> <span class="kr">thread</span> <span class="n">terminates</span><span class="p">.</span>
           
</code></pre></td></tr></table>
</div>
</div><h5 id="man-exit">man exit</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">exit - cause normal process termination

 The exit() function causes normal process termination and the value
       of status &amp; 0377 is returned to the parent (see wait(2)).
  çœ‹è¿›ç¨‹çš„é”€æ¯å›¾ç‰‡         
  All functions registered with atexit(3) and on_exit(3) are called, in
       the reverse order of their registration.

  
  NOTE
 è¿›ç¨‹é”€æ¯ ä¸Šä¸‹éƒ½è¦æ‰“ç‚¹
 
   After exit(), the exit status must be transmitted to the parent
       process.  There are three cases:

       Â·  If the parent has set SA_NOCLDWAIT, or has set the SIGCHLD handler
          to SIG_IGN, the status is discarded and the child dies
          immediately.

       Â·  If the parent was waiting on the child, it is notified of the exit
          status and the child dies immediately.

       Â·  Otherwise, the child becomes a &#34;zombie&#34; process: most of the
          process resources are recycled, but a slot containing minimal
          information about the child process (termination status, resource
          usage statistics) is retained in process table.  This allows the
          parent to subsequently use waitpid(2) (or similar) to learn the
          termination status of the child; at that point the zombie process
          slot is released.

       If the implementation supports the SIGCHLD signal, this signal is
       sent to the parent.  If the parent has set SA_NOCLDWAIT, it is
       undefined whether a SIGCHLD signal is sent.

   Signals sent to other processes
       If the exiting process is a session leader and its controlling
       terminal is the controlling terminal of the session, then each
       process in the foreground process group of this controlling terminal
       is sent a SIGHUP signal, and the terminal is disassociated from this
       session, allowing it to be acquired by a new controlling process.

       If the exit of the process causes a process group to become orphaned,
       and if any member of the newly orphaned process group is stopped,
       then a SIGHUP signal followed by a SIGCONT signal will be sent to
       each process in this process group.  See setpgid(2) for an
       explanation of orphaned process groups.
</code></pre></td></tr></table>
</div>
</div><p><a href="http://man7.org/linux/man-pages/man3/pthread_detach.3.html">http://man7.org/linux/man-pages/man3/pthread_detach.3.html</a></p>
<p><a href="https://www.youtube.com/watch?v=q3-5sDe6lzg">https://www.youtube.com/watch?v=q3-5sDe6lzg</a></p>
<p><a href="https://stackoverflow.com/questions/6042970/pthread-detach-question">https://stackoverflow.com/questions/6042970/pthread-detach-question</a></p>
<p><a href="https://medium.com/@vgasparyan1995/let-me-detach-those-threads-for-you-2de014b26394">https://medium.com/@vgasparyan1995/let-me-detach-those-threads-for-you-2de014b26394</a></p>
<h3 id="3çº¿ç¨‹å®‰å…¨">3.çº¿ç¨‹å®‰å…¨</h3>
<blockquote>
<p>é™ˆå’¬é‡‘çš„ä¸‰æ¿æ–§ æ¥äº†</p>
<p>ç¬¬ä¸€æ–§ï¼šæŠ€æœ¯æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç¬¬äºŒæ–§ï¼šè€ƒè™‘å“ªäº›é—®é¢˜ï¼Ÿ</p>
<p>ç¬¬ä¸‰æ–§ï¼šå¦‚ä½•ä½¿ç”¨ï¼Ÿ</p>
</blockquote>
<h4 id="ç¬¬ä¸€æ–§æŠ€æœ¯æœ¬è´¨æ˜¯ä»€ä¹ˆ">ç¬¬ä¸€æ–§ï¼šæŠ€æœ¯æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</h4>
<h4 id="ç¬¬äºŒæ–§è€ƒè™‘å“ªäº›é—®é¢˜">ç¬¬äºŒæ–§ï¼šè€ƒè™‘å“ªäº›é—®é¢˜ï¼Ÿ</h4>
<ul>
<li>çº¿ç¨‹å¯é‡å…¥</li>
<li>çº¿ç¨‹ä¸ä¿¡å·</li>
<li>çº¿ç¨‹ä¸fork</li>
</ul>
<h4 id="ç¬¬ä¸‰æ–§å¦‚ä½•ä½¿ç”¨">ç¬¬ä¸‰æ–§ï¼šå¦‚ä½•ä½¿ç”¨ï¼Ÿ</h4>
<h2 id="è¿›ç¨‹">è¿›ç¨‹</h2>
<h3 id="ä¸€-è¿›ç¨‹åˆ›å»ºæ–¹å¼">ä¸€. è¿›ç¨‹åˆ›å»ºæ–¹å¼</h3>
<ul>
<li>Linuxè¿›ç¨‹åˆ›å»ºï¼š é€šè¿‡fork()ç³»ç»Ÿè°ƒç”¨åˆ›å»ºè¿›ç¨‹</li>
<li>Linuxç”¨æˆ·çº§çº¿ç¨‹åˆ›å»ºï¼šé€šè¿‡pthreadåº“ä¸­çš„pthread_create()åˆ›å»ºçº¿ç¨‹</li>
<li>Linuxå†…æ ¸çº¿ç¨‹åˆ›å»ºï¼š é€šè¿‡kthread_create()</li>
</ul>
<p>fork, vfork, cloneæ ¹æ®ä¸åŒå‚æ•°è°ƒç”¨do_fork</p>
<ul>
<li>pthread_create: flagså‚æ•°ä¸º CLONE_VM, CLONE_FS, CLONE_FILES, CLONE_SIGHAND</li>
<li>fork: flagså‚æ•°ä¸º SIGCHLD</li>
<li>vfork: flagså‚æ•°ä¸º CLONE_VFORK, CLONE_VM, SIGCHLD</li>
</ul>
<h4 id="è¿è¡Œåº”ç”¨ç¨‹åº-ç”±fork--execå¯¹å®Œæˆ-">è¿è¡Œåº”ç”¨ç¨‹åº( ç”±fork / execå¯¹å®Œæˆ )</h4>
<p>å¯åŠ¨ç¨‹åºä¸€èˆ¬éƒ½æ˜¯åœ¨å‘½ä»¤è¡Œä¸­ï¼Œå…¶å®æ˜¯åœ¨ä¸<code>shell</code>æ‰“äº¤é“ï¼Œç„¶å<code>shell</code>å¸®æˆ‘ä»¬å¯åŠ¨ç¨‹åº</p>
<blockquote>
<p>shell æ¯æ¬¡æ‰§è¡ŒæŒ‡ä»¤ï¼Œ éœ€è¦ fork å‡ºä¸€ä¸ªå­è¿›ç¨‹æ¥æ‰§è¡Œï¼Œç„¶åå°†å­è¿›ç¨‹çš„é•œåƒæ›¿æ¢æˆç›®æ ‡æŒ‡ä»¤ï¼Œ</p>
<p>è¿™åˆä¼šç”¨åˆ° exec å‡½æ•°ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ¡ç®€å•çš„æŒ‡ä»¤</p>
<p>puttyå·¥å…·ç™»å½•</p>
</blockquote>
<p><img src="https://i.loli.net/2019/11/30/fvt5JX4mZ3AUOFB.png" alt="image.png"></p>
<p>å‚è€ƒ</p>
<p><a href="https://juejin.im/post/5bc98b36f265da0af93b34c6">ä¸€ä¸ªå°å°çš„ Shell ç®¡é“ç¬¦ï¼Œå†…éƒ¨å®ç°å¯çœŸä¸ç®€å•ï¼</a></p>
<p><a href="https://github.com/gatieme/LDD-LinuxDeviceDrivers/tree/master/study/kernel/01-process/03-execute/01-do_execve">Linuxè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹åˆ†ædo_execve(å¯æ‰§è¡Œç¨‹åºçš„åŠ è½½å’Œè¿è¡Œ)</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="n">strace</span> <span class="p">.</span><span class="o">/</span><span class="n">a</span><span class="p">.</span><span class="n">out</span>
<span class="n">execve</span><span class="p">(</span><span class="s">&#34;./a.out&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;./a.out&#34;</span><span class="p">],</span> <span class="p">[</span><span class="cm">/* 30 vars */</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">brk</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>                               <span class="o">=</span> <span class="mh">0xd9e000</span>
<span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7f52dcaaa000</span>
    
<span class="n">The</span>  <span class="n">exec</span><span class="p">()</span>  <span class="n">family</span> <span class="n">of</span> <span class="n">functions</span> <span class="n">replaces</span> <span class="n">the</span> <span class="n">current</span> <span class="n">process</span> <span class="n">image</span> <span class="n">with</span> <span class="n">a</span> <span class="k">new</span> <span class="n">process</span> <span class="n">image</span>
    
    
<span class="n">strace</span> <span class="n">ls</span>
<span class="n">execve</span><span class="p">(</span><span class="s">&#34;/bin/ls&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#34;ls&#34;</span><span class="p">],</span> <span class="p">[</span><span class="cm">/* 29 vars */</span><span class="p">])</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">brk</span><span class="p">(</span><span class="nb">NULL</span><span class="p">)</span>                               <span class="o">=</span> <span class="mh">0x19aa000</span>
<span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span><span class="o">|</span><span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mh">0x7fc7e7ad6000</span>
<span class="n">access</span><span class="p">(</span><span class="s">&#34;/etc/ld.so.preload&#34;</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">)</span>      <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>
<span class="n">open</span><span class="p">(</span><span class="s">&#34;tls/x86_64/libselinux.so.1&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>
<span class="n">open</span><span class="p">(</span><span class="s">&#34;tls/libselinux.so.1&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>
<span class="n">open</span><span class="p">(</span><span class="s">&#34;x86_64/libselinux.so.1&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>
<span class="n">open</span><span class="p">(</span><span class="s">&#34;libselinux.so.1&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">ENOENT</span> <span class="p">(</span><span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span><span class="p">)</span>    
</code></pre></td></tr></table>
</div>
</div><h4 id="close_on_exec-æœºåˆ¶">close_on_exec æœºåˆ¶</h4>
<blockquote>
<p>é™ˆå’¬é‡‘çš„ä¸‰æ¿æ–§ æ¥äº†</p>
</blockquote>
<ul>
<li>èƒŒååŸç†æ˜¯ä»€ä¹ˆ</li>
</ul>
<p><img src="https://i.loli.net/2019/11/30/YjhLt2KDZiylzvW.png" alt="image.png"></p>
<p><a href="https://en.wikipedia.org/wiki/File_descriptor#Operations_on_the_file_descriptor_table"><strong>æ–‡ä»¶æè¿°ç¬¦</strong></a>ï¼ˆFile descriptorï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ˜¯ä¸€ä¸ªç”¨äºè¡¨è¿°æŒ‡å‘<a href="https://zh.wikipedia.org/wiki/%E6%96%87%E4%BB%B6">æ–‡ä»¶</a>çš„å¼•ç”¨çš„æŠ½è±¡åŒ–æ¦‚å¿µã€‚</p>
<p><a href="https://vvl.me/2019/06/file-descriptor-statistical-method-under-linux/">Linux ä¸‹æ–‡ä»¶æè¿°ç¬¦çš„ç»Ÿè®¡æ–¹æ³•</a></p>
<p>fork åï¼Œå­è¿›ç¨‹ä¼šè·å¾—çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ›´å…·ä½“åœ°è¯´ï¼ŒLinux ä¸‹æ˜¯æœªè®¾ç½® <code>CLONE_FILES</code> flag çš„ç³»ç»Ÿè°ƒç”¨ <code>clone()</code>ï¼‰ã€‚</p>
<p>å­è¿›ç¨‹æ‰§è¡Œ exec çš„åï¼Œå†…æ ¸ä¸å†ä¿ç•™åŸæœ‰çš„ fdtableï¼Œæ— æ³•å†æ ¹æ®æ–‡ä»¶æè¿°ç¬¦æ“ä½œæ–‡ä»¶</p>
<p>exec æµç¨‹</p>
<ol>
<li>fork</li>
<li>é”€æ¯</li>
<li>æ›¿æ¢</li>
</ol>
<ul>
<li>èƒ½è§£å†³ä»€ä¹ˆé—®é¢˜</li>
</ul>
<p>â€‹       è¿›ç¨‹/çº¿ç¨‹ å› ä¸ºå­˜åœ¨ Too many open filesï¼ˆç«¯å£ä¹Ÿæ˜¯æ–‡ä»¶ï¼‰ ï¼Œé€ æˆåˆ›å»ºå¤±è´¥</p>
<pre><code>sysctl -a | grep file-max
fs.file-max = 655360
</code></pre>
<ul>
<li>å¦‚ä½•è§£å†³çš„</li>
</ul>
<p><a href="https://blog.csdn.net/cywosp/article/details/38965239">æ–‡ä»¶æè¿°ç¬¦æ ‡å¿—</a>ï¼ˆå³ï¼Œclose-on-execï¼‰ä¸ºè¿›ç¨‹å’Œæ–‡ä»¶æè¿°ç¬¦æ‰€ç§æœ‰ã€‚</p>
<p>å¯¹è¿™ä¸€æ ‡å¿—çš„ä¿®æ”¹å°†ä¸ä¼šå½±å“åŒä¸€è¿›ç¨‹æˆ–ä¸åŒè¿›ç¨‹ä¸­çš„å…¶ä»–æ–‡ä»¶æè¿°ç¬¦</p>
<p>å¦‚æœå¯¹æè¿°ç¬¦è®¾ç½®äº†FD_CLOEXECï¼Œåœ¨ä½¿ç”¨execlè°ƒç”¨æ‰§è¡Œçš„ç¨‹åºé‡Œï¼Œæ­¤æè¿°ç¬¦å°†åœ¨å­è¿›ç¨‹ä¸­ä¼šè¢«è‡ªåŠ¨å…³é—­ï¼Œä¸èƒ½ä½¿ç”¨äº†ã€‚ä½†æ˜¯åœ¨çˆ¶è¿›ç¨‹ä¸­ä»ç„¶å¯ä»¥ä½¿ç”¨</p>
<p>Linuxç³»ç»Ÿçš„openå‡½æ•°ï¼Œå…¶ä¸­flagså‚æ•°å¯ä»¥ä¼ å…¥O_CLOEXECæ ‡è®°ï¼Œå³å¯è‡ªåŠ¨è®¾ç½®ä¸ŠFD_CLOEXECæ ‡è®°ï¼Œä½†Linuxå†…æ ¸ç‰ˆæœ¬2.6.23æ‰å¼€å§‹æ”¯æŒæ­¤æ ‡è®°ã€‚</p>
<p>æ¥æºï¼š<a href="http://blogs.360.cn/post/nginx%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%B3%84%E9%9C%B2%EF%BC%9F%E6%B5%85%E6%9E%90fd_cloexec%E6%96%87%E4%BB%B6%E6%8F%8F%E8%BF%B0%E7%AC%A6%E6%A0%87%E5%BF%97.html">Nginxæ–‡ä»¶æè¿°ç¬¦æ³„éœ²ï¼Ÿæµ…æFD_CLOEXECæ–‡ä»¶æè¿°ç¬¦æ ‡å¿—</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c++" data-lang="c++"><span class="nl">TCP</span><span class="p">:</span>
<span class="cp">#ifdef WIN32
</span><span class="cp"></span>	<span class="n">SOCKET</span> <span class="n">ss</span> <span class="o">=</span> <span class="o">::</span><span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else
</span><span class="cp"></span>	<span class="n">SOCKET</span> <span class="n">ss</span> <span class="o">=</span> <span class="o">::</span><span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span> <span class="o">|</span> <span class="n">SOCK_CLOEXEC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="cp"></span>
<span class="err">æ–‡ä»¶ï¼š</span>
<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">â€œ</span><span class="n">foo</span><span class="p">.</span><span class="n">txt</span><span class="err">â€</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFD</span><span class="p">);</span>
<span class="n">flags</span> <span class="o">|=</span> <span class="n">FD_CLOEXEC</span><span class="p">;</span>
<span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="err">â€œ</span><span class="n">foo</span><span class="p">.</span><span class="n">txt</span><span class="err">â€</span><span class="p">,</span><span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>


 <span class="n">O_CLOEXEC</span> <span class="p">(</span><span class="n">since</span> <span class="n">Linux</span> <span class="mf">2.6.23</span><span class="p">)</span>
              <span class="n">Enable</span> <span class="n">the</span> <span class="n">close</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">exec</span> <span class="n">flag</span> <span class="k">for</span> <span class="n">the</span> <span class="k">new</span> <span class="n">file</span> <span class="n">descriptor</span><span class="p">.</span>
              <span class="n">Specifying</span> <span class="k">this</span> <span class="n">flag</span> <span class="n">permits</span> <span class="n">a</span> <span class="n">program</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">additional</span>
              <span class="n">fcntl</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">F_SETFD</span> <span class="n">operations</span> <span class="n">to</span> <span class="n">set</span> <span class="n">the</span> <span class="n">FD_CLOEXEC</span> <span class="n">flag</span><span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<h3 id="ä¸ºä»€ä¹ˆclose_on_execä¸æ˜¯é»˜è®¤é…ç½®httpswwwthinbugcomq9583845"><a href="https://www.thinbug.com/q/9583845">ä¸ºä»€ä¹ˆclose_on_execä¸æ˜¯é»˜è®¤é…ç½®ï¼Ÿ</a></h3>
</li>
</ul>
<p>å› ä¸ºåœ¨UNIXä¸Šï¼Œæœ€å¸¸ç”¨çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯è¿›ç¨‹ä¹‹é—´çš„ç®¡é“æµ - å¦‚æœè®¾ç½®äº†CLOEXECæ ‡å¿—ï¼Œåˆ™ä¸èƒ½è¿™æ ·åšæ ‡å‡†I/O</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ•´æ•°å€¼</th>
<th style="text-align:center">åç§°</th>
<th style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Unistd.h">unistd.h</a></th>
<th style="text-align:center">æ–‡ä»¶æµ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Stdin">Standard input</a></td>
<td style="text-align:center">STDIN_FILENO</td>
<td style="text-align:center">stdin</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Stdout">Standard output</a></td>
<td style="text-align:center">STDOUT_FILENO</td>
<td style="text-align:center">stdout</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center"><a href="https://zh.wikipedia.org/wiki/Stderr">Standard error</a></td>
<td style="text-align:center">STDERR_FILENO</td>
<td style="text-align:center">stderr</td>
</tr>
</tbody>
</table>
<h3 id="äºŒ-è¿›ç¨‹çš„é”€æ¯">äºŒã€ è¿›ç¨‹çš„é”€æ¯</h3>
<blockquote>
<p>é™ˆå’¬é‡‘çš„ä¸‰æ¿æ–§ æ¥äº†</p>
<p>ç¬¬ä¸€æ–§ï¼šæŠ€æœ¯æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç¬¬äºŒæ–§ï¼šè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<p>ç¬¬ä¸‰æ–§ï¼šå¦‚ä½•ä½¿ç”¨ï¼Ÿ</p>
</blockquote>
<p><img src="https://i.loli.net/2019/11/30/JVsLgbNcoDPwFIy.png" alt="image.png"></p>
<p><img src="https://i.loli.net/2019/11/30/CQ9bs74IjiomLTO.png" alt="image.png"></p>
<p><img src="https://images0.cnblogs.com/blog/529981/201307/12164358-cc25532dd77e43e59caab3472e9f319e.png" alt="QQæˆªå›¾20130712154916"></p>
<p>what-would-you-use-an-exit-handler-</p>
<p>ä¸åŒè¯­è¨€ç±»æ¯”(c/golang/python/java)</p>
<blockquote>
<p>python  The <a href="https://docs.python.org/3/library/atexit.html#module-atexit"><code>atexit</code></a> module defines functions to register and unregister cleanup functions</p>
<p>golang  <a href="https://gobyexample.com/defer"><em>Defer</em> i</a>s used to ensure that a function call is performed later in a programâ€™s execution, usually for purposes of cleanup</p>
<p>java  hooks</p>
</blockquote>
<p><img src="https://i.loli.net/2019/11/30/9rzlZ34KDHLfeY2.png" alt="image.png"></p>
<h1 id="ç›¸å…³é—®é¢˜">ç›¸å…³é—®é¢˜</h1>
<ul>
<li>Linuxä¸­forkå­è¿›ç¨‹åå†execæ–°ç¨‹åºæ—¶æ–‡ä»¶æè¿°ç¬¦çš„é—®é¢˜ï¼Ÿ</li>
<li>å…³äºlinuxè¿›ç¨‹é—´çš„<a href="https://cloud.tencent.com/developer/article/1177094">close-on-exec</a>æœºåˆ¶</li>
<li><a href="https://xnerv.wang/linux-process-kernel-and-file-system-summary/">LinuxThreadsçš„ä¸è¶³</a></li>
<li>TCP listening sockets created without FD_CLOEXEC flag</li>
<li>ä¸ºä»€ä¹ˆä½¿ç”¨execveåˆ›å»ºè¿œç¨‹shellä¸ä¼šè¦†ç›–æ–‡ä»¶æè¿°ç¬¦å’Œå¥—æ¥å­—ï¼Ÿ</li>
<li>C å’Œ Golang çœŸçš„æœ‰åƒä¸ä¸‡ç¼•çš„è”ç³»ï¼Œæ¯”å¦‚ <code>atexit()</code> ä¸ <code>defer func(){}</code></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Troy</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2019-11-29 00:00
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">è®¸å¯åè®®</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/nusr/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/book/">book</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2020/%E6%8F%90%E9%AB%98%E5%B7%A5%E4%BD%9C%E6%95%88%E7%8E%87%E7%9A%84%E5%87%A0%E4%B8%AA%E5%B7%A5%E5%85%B7/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">æé«˜å·¥ä½œæ•ˆç‡çš„å‡ ä¸ªå·¥å…·</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/post/2020/%E6%A8%A1%E6%9D%BF/">
            <span class="next-text nav-default">è®¾è®¡ä¹‹ç¦…</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="wangcy6/wangcy6.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wang_cyi@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/wangcy6" class="iconfont icon-github" title="github"></a>
  <a href="https://wangcy6.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> æ¬¡ </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> äºº </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2017 - 
    2025
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Troy</span>
  </span>
</div>
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js"></script>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
