<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>早起120小时写代码第一期：kvcore - Troy的网络博客</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Troy" /><meta name="description" content="早睡：21点准备 22点上床，早起 6点准备 ，8点-10点 120分钟" /><meta name="keywords" content="daily-interview-question, Github, c&#43;&#43;, Leetcode 题解, 后端面试" />






<meta name="generator" content="Hugo 0.62.0 with theme even" />


<link rel="canonical" href="https://wangcy6.github.io/post/2022/07_2022_4_17_kvcore/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="早起120小时写代码第一期：kvcore" />
<meta property="og:description" content="早睡：21点准备 22点上床，早起 6点准备 ，8点-10点 120分钟" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wangcy6.github.io/post/2022/07_2022_4_17_kvcore/" />
<meta property="article:published_time" content="2022-04-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-04-17T00:00:00+00:00" />
<meta itemprop="name" content="早起120小时写代码第一期：kvcore">
<meta itemprop="description" content="早睡：21点准备 22点上床，早起 6点准备 ，8点-10点 120分钟">
<meta itemprop="datePublished" content="2022-04-17T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2022-04-17T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2244">



<meta itemprop="keywords" content="60秒问答," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="早起120小时写代码第一期：kvcore"/>
<meta name="twitter:description" content="早睡：21点准备 22点上床，早起 6点准备 ，8点-10点 120分钟"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="https://github.com/wangcy6/weekly/tree/master/book">
        <li class="mobile-menu-item">阅读清单</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="https://github.com/wangcy6/weekly/tree/master/book">阅读清单</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">早起120小时写代码第一期：kvcore</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-04-17 00:00 </span>
        
          <span class="more-meta"> 约 2244 字 </span>
          <span class="more-meta"> 预计阅读 5 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#day2--memory">day2:  memory</a>
      <ul>
        <li><a href="#heading">阅读资料</a></li>
        <li><a href="#day3">day3</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
  <div class="post-outdated">
    <div class="warn">
      <p>【注意】最后更新于 <span class="timeago" datetime="2022-04-17T00:00:00" title="April 17, 2022">April 17, 2022</span>，文中内容可能已过时，请谨慎使用。</p>
    </div>
  </div>
    <div class="post-content">
      <h4 id="day1-2022-4-17---622--httpsbookdoubancomsubject20260640">day1： 2022-4-17 看斗鱼 看手机 晚上6点22点 时间规划和紧急措施陷入时间黑洞 #<a href="https://book.douban.com/subject/20260640//">象与骑象人</a>，根本控制不大象，强制无效</h4>
<p><a href="https://hardcore.feishu.cn/mindnotes/bmncnnOV8YnRi9CU04RZwhYGqte">手写KV引擎(第一部分)-实现单机kv引擎</a></p>
<p><a href="https://hardcore.feishu.cn/mindnotes/bmncnzpUmXNQruVGOwRwisHyxoh">【硬核课堂】LevelDB 源码分析</a></p>
<p>git clone <a href="mailto:git@github.com">git@github.com</a>:wangcy6/coreKV-CPP.git</p>
<p>lesson05-sstable</p>
<p><a href="https://hardcore.feishu.cn/docs/doccnjVdgWAfAEmg3g1HYqKvyhg">https://hardcore.feishu.cn/docs/doccnjVdgWAfAEmg3g1HYqKvyhg</a></p>
<h5 id="lesson11-skiplist">Lesson1.1 skiplist</h5>
<ul>
<li>文档：https://hardcore.feishu.cn/docs/doccnPpGqZcPRpHwmSSGVUQhs5f</li>
<li>提问1：<a href="https://www.zhihu.com/question/20202931">面试官：为啥 redis 使用跳表(skiplist)而不是使用 red-black？</a></li>
</ul>
<blockquote>
<p>Skip lists: a probabilistic alternative to balanced trees</p>
<p><a href="https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990.pdf">https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990.pdf</a></p>
</blockquote>
<ul>
<li>. If p = 1/2, using MaxLevel = 16 is appropriate for data structures containing up to 216 elements.</li>
</ul>
<p>​</p>
<blockquote>
<p>看java怎么实现的</p>
</blockquote>
<p>​      <a href="https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/share/classes/java/util/concurrent/ConcurrentSkipListMap.java">https://github.com/openjdk-mirror/jdk7u-jdk/blob/master/src/share/classes/java/util/concurrent/ConcurrentSkipListMap.java</a></p>
<ul>
<li><a href="https://www.cl.cam.ac.uk/research/srg/netos/papers/2007-cpwl.pdf">https://www.cl.cam.ac.uk/research/srg/netos/papers/2007-cpwl.pdf</a> [提问]</li>
</ul>
<ol>
<li>
<p>范围查找等价</p>
</li>
<li>
<p>redis的sl层级比二叉平衡树要低很多，源码中SKIPLIST_P用的是0.25，层次数期望值相当于四叉平衡树</p>
</li>
<li>
<p>skip list 是 Concurrency-Friendly，Non-Blocking</p>
</li>
</ol>
<blockquote>
<p>看c++怎么实现的？原子操作和顺序一致性 对比</p>
<p>C++ Concurrency in Action</p>
<p>位置：第一本书:c++ 11 必读书籍 Effective Modern C++</p>
</blockquote>
<blockquote>
<p>看 文章自己写的</p>
</blockquote>
<ul>
<li>Choose Concurrency-Friendly Data Structures（翻译）</li>
<li><a href="https://herbsutter.com/2008/06/27/effective-concurrency-choose-concurrency-friendly-data-structures/">Effective Concurrency: Choose Concurrency-Friendly Data Structures</a></li>
<li><a href="https://programmerclick.com/article/70581257539/">https://programmerclick.com/article/70581257539/</a></li>
</ul>
<ol>
<li>To illustrate, let's consider two common data structures: linked lists and balanced trees.</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">So red-black trees cause some problems for concurrent code:

It&#39;s hard to run updates truly concurrently because updates arbitrarily far apart in the tree can touch the same nodes—especially the root, but also other higher-level nodes to lesser degrees—and therefore contend with each other. We have lost the ability to make truly localized changes.

The tree performs extra internal housekeeping writes. This increases the amount of shared data that needs to be written and synchronized across caches to publish what would be a small update in another data structure.

所以红黑树给并发代码带来了一些问题：
很难真正同时运行更新，因为在树中任意相隔很远的更新可能会触及相同的节点——尤其是根，但也会触及其他更高级别的节点，但程度较低——因此会相互竞争。 我们已经失去了进行真正本地化更改的能力。
树执行额外的内部管理写入。 这增加了需要跨缓存写入和同步的共享数据量，以发布另一个数据结构中的小更新
</code></pre></td></tr></table>
</div>
</div><h2 id="day2--memory">day2:  memory</h2>
<h3 id="heading">阅读资料</h3>
<ul>
<li>
<p><input disabled="" type="checkbox"><a href="https://hardcore.feishu.cn/docs/doccngOEJpWCod99boj8LHbt43c">https://hardcore.feishu.cn/docs/doccngOEJpWCod99boj8LHbt43c</a></p>
<p>开始日期：4-27 20:11    &mdash;结束日期：</p>
<ul>
<li>记free 多次引发的内存踩踏事件</li>
<li><a href="http://mingxinglai.com/cn/2013/01/leveldb-arena/">LevelDB源码剖析之Arena内存管理</a></li>
<li>【leveldb】arena内存结构</li>
<li>基础1：中庸之道 —— arena内存管理</li>
<li>面试中遇到的问题：一个指针重复释放会出现什么情况</li>
<li><a href="https://zhuanlan.zhihu.com/p/452697297">内存管理：设计Arena</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox">问题来源：</p>
<p>章节：corekv-cpp之内存池</p>
<p>函数：void* SimpleFreeListAlloc::Allocate(int32_t n)</p>
</li>
</ul>
<p>​</p>
<p>​          memory_usage_.fetch_add(n, std::memory_order_relaxed);</p>
<p>​           多线程 加锁 级别自己分不清楚。</p>
<p>阅读：</p>
<ol>
<li>C++11多线程 内存序<a href="https://blog.csdn.net/qls315/article/details/119930248">(std::memory_order_relaxed</a>)</li>
<li><strong>C++ Concurrency in Action</strong></li>
<li><a href="https://www.cplusplus.com/reference/atomic/">https://www.cplusplus.com/reference/atomic/</a></li>
<li>C++11多线程 内存序(std::memory_order_consume)</li>
</ol>
<p>结果：</p>
<p><em>Modification orders</em></p>
<p><strong>data dependency</strong></p>
<p>atomic operations on the same object may never be reordered</p>
<p><a href="https://blog.csdn.net/qls315/article/details/120431567">针对同一个对象的原子操作不会被重排序。</a></p>
<p>关于std::memory_order_relaxed具备如下几个功能：</p>
<p>作用于原子变量
不具有synchronizes-with关系
对于同一个原子变量，在同一个线程中具有happens-before关系（言外之意，不同的原子变量不具有happens-before关系，可以乱序执行）
由3可知，在一个线程中，如果某个表达式已经看到原子变量的某个值a，则该表达式的后续表达式只能看到a或者比a更新的值
————————————————
版权声明：本文为CSDN博主「qls315」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：https://blog.csdn.net/qls315/article/details/119930248</p>
<ol>
<li>阅读文章：https://blog.csdn.net/qls315/article/details/119930248</li>
</ol>
<p>输出：同样代码 memory_order_relaxed具备如下几个功能：不保证同步</p>
<ol start="2">
<li>第五章节 p143</li>
</ol>
<p>happens-before relationship</p>
<ul>
<li>
<p><input disabled="" type="checkbox"></p>
<p>章节：corekv-cpp之内存池</p>
<p>函数：void* SimpleFreeListAlloc::Allocate(int32_t n)</p>
<p>select_free_list = freelist_ + M_FreelistIndex(n);</p>
<p>问题1： freelist_都是空闲的内存吗？为啥没有遍历直接获取了。分配也没有标记该node被使用？</p>
<p>问题2:和freelist_ union设计有关系吗？这个stl源码解析 houjie时候 没看明白?</p>
<p>多个空闲链表 判断是否被占用，union 结果能实现遍历吗？</p>
</li>
</ul>
<p>atomic类
多线程通过fetch__xx函数 一个变量进行 加减没有问题。</p>
<p>多线程 对不同变量进行 做同步 load,store 使用条件是什么？</p>
<p>例如 
x y 写操作必须在同一个线程内完成，才满足 happens-before and synchronizes-with。
2个线程分别 x 和y写 肯定不满足</p>
<p>The happens-before relationship</p>
<p>英文：Listing 5.10 Using std::memory_order_consume to synchronize data
<a href="https://en.cppreference.com/w/cpp/atomic/memory_order">https://en.cppreference.com/w/cpp/atomic/memory_order</a></p>
<p>中文：https://blog.csdn.net/qls315/article/details/119930248</p>
<p>memory_order_acquire: （可以理解为 mutex 的 lock 操作）</p>
<ol>
<li>对读取施加 acquire 语义（load），在代码中这条语句后面所有读写操作都无法重排到这个操作之前，即 load-store 不能重排为 store-load, load-load 也无法重排为 load-load</li>
<li>在这个原子变量上施加 release 语义的操作发生之后，acquire 可以保证读到所有在 release 前发生的写入</li>
</ol>
<p>memory_order_acquire：修饰load操作。</p>
<ol>
<li>后面读写操作代码，顺序，不能提前执行。</li>
<li>我读取是比尔写入成功的。</li>
</ol>
<p>memory_order_acquire
memory_order_consume：</p>
<p>atomic_compare_exchange_strong</p>
<p>知道c++提供原子操作类atomic<!-- raw HTML omitted --> 提供的接口有哪几个？</p>
<p>4个 
atomic_fetch_add 
atomic_load 
atomic_store 
atomic_compare_exchange_strong</p>
<p>memory_order_release:（可以理解为 mutex 的 unlock 操作）</p>
<ol>
<li>
<p>对写入施加 release 语义（store），
在代码中这条语句前面的所有读写操作都无法被重排到这个操作之后
，即 store-store 不能重排为 store
load-store 
也无法重排为 store-load</p>
</li>
<li>
<p>当前线程内的所有写操作，对于其他对这个原子变量进行 acquire 的线程可见</p>
</li>
<li>
<p>当前线程内的与这块内存有关的所有写操作，对于其他对这个原子变量进行 consume 的线程可见
<a href="https://www.cnblogs.com/lizhanzhe/p/10893016.html">https://www.cnblogs.com/lizhanzhe/p/10893016.html</a></p>
</li>
</ol>
<h3 id="day3">day3</h3>
<ol>
<li>LSM-tree读写放大</li>
</ol>
<ul>
<li>LSM-tree 的主要劣势是读写放大【不明白】</li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Troy</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2022-04-17 00:00
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a target="_blank" rel="license noopener" href="https://github.com/nusr/blog/blob/master/LICENSE">MIT</a></span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/60%E7%A7%92%E9%97%AE%E7%AD%94/">60秒问答</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022/08_2022_4_17_epoll/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">操作系统入门知识--网络</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/interview/tidb/2022/01_2022_4_14_tiflsh_study/">
            <span class="next-text nav-default">成为tiflash贡献者第一天</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="wangcy6/wangcy6.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:wang_cyi@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/wangcy6" class="iconfont icon-github" title="github"></a>
  <a href="https://wangcy6.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2017 - 
    2025
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Troy</span>
  </span>
</div>
<script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget/autoload.js"></script>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js" integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js" integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin="anonymous"></script>
  <script><!-- NOTE: timeago.js uses the language code format like "zh_CN" (underscore and case sensitive) -->
    var languageCode = "zh-cn".replace(/-/g, '_').replace(/_(.*)/, function ($0, $1) {return $0.replace($1, $1.toUpperCase());});
    timeago().render(document.querySelectorAll('.timeago'), languageCode);
    timeago.cancel();  
  </script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-138883536-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
