---
title: 从青铜到王者系列：对象存储服务性能调优
date: 2022-11-20
description: ""
draft: false
tags:
  - book
---

## 如何学习

~~~
 一、这个技术出现的背景、初衷和要达到什么样的目标或是要解决什么样的问题 

 二、这个技术的优势和劣势分别是什么 

三、这个技术适用的场景。任何技术都有其适用的场景，离开了这个场景

四、技术的组成部分和关键点。

五、技术的底层原理和关键实现

六、已有的实现和它之间的对比
~~~





带宽: 每秒的吞吐量，即每 秒可以完成读/写的数据量
OPS：每  秒可以处理客户端业务请求的个 数


# 网络调优

## 存储节点服务器网络检查命令
### 1 ifconfig

ifconfig - configure a network interface

查看接口数是否正常， IP地址是否正常，“ errors”、“ overruns”、“ frame”计  
数是否正常。所谓异常

所谓异常：  
– 使用的接口无统计数据。  
– 与后端10GE交换机相连的网口“ error”、“ overruns”、“ frame”统计数据  
不为0。  

overruns有计数，需要检查对应[交换机]接口有没有配置flow-control； 
frame有 计数，需要抓包确认有没有重传。  

– SLOT5-0、 SLOT4-0收发包数差距很大。

- 对于存储节点的RoCE网卡（ 10GE组网），还应包含名称为SLOT4-0.2或  
  SLOT5-0.2的网口的显示结果

- 产品名称：200G网卡 Mellanox CX6 MCX653106A HDAT HDR IB卡 双口
    
    该网卡适用于高速数据中心网络，支持InfiniBand（IB）网络技术，
    适用于高性能计算（HPC）、云计算、大数据分析等场景。
    

#### **接口错误计数（errors/overruns/frame）**

- **关键统计项**：
    
    - **errors**: 物理层或协议栈错误（CRC错误、畸形包）。
    - **overruns**: 输入队列满导致内核丢弃数据包，通常因处理速度不足。
    - **frame**: 帧格式错误（如长度不匹配、对齐问题）。

|`frame`|校验错误或重传|物理层故障、MTU不匹配、重传冲突|更换硬件、统一MTU、抓包优化|

ens47f0: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> **mtu 1500** qdisc mq master bond0 state UP group default qlen 8192



#### **数据包分片与重组**

- 若发送方 MTU（例如 `9000`） > 路径中某设备 MTU（例如 `1500`）：  
    发送方未设置 `DF（Don't Fragment）` 标志：数据包被分片传输，降低效率。  
    发送方设置 `DF` 标志：接收端返回 `ICMP Fragmentation Needed` 错误，导致通信失败

## 2 【ethtool】ethtool 网卡诊断、调整工具、网卡性能优化| 解决丢包严重


~~~

ethtool - query or control network driver and hardware settings

ethtool ens49f1
Settings for ens49f1:
        Supported ports: [ TP ]
        Supported link modes:   10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Supported pause frame use: Symmetric
        Supports auto-negotiation: Yes
        Supported FEC modes: Not reported
        Advertised link modes:  10baseT/Half 10baseT/Full
                                100baseT/Half 100baseT/Full
                                1000baseT/Full
        Advertised pause frame use: Symmetric
        Advertised auto-negotiation: Yes
        Advertised FEC modes: Not reported
        Speed: 1000Mb/s
        Duplex: Full
        Port: Twisted Pair
        PHYAD: 1
        Transceiver: internal
        Auto-negotiation: on
        MDI-X: on (auto)
        Supports Wake-on: pumbg
        Wake-on: d
        Current message level: 0x00000007 (7)
                               drv probe link
        Link detected: yes

~~~


ethtool -i SLOT4-1：  看网口驱动版本，可以识别接口类型和厂商，比如cxgb4是  
Chelsio卡， ixgbe是Intel 10GE卡。

lspci |grep Ether：确认用的是什么型号的网卡


### 3. netstat  
netstat -s |grep Retrans检查重传个数，确认是否有重传。  
TCPLostRetransmit: 1146


### 4. 实时查看网卡流量 sar -n DEV 2  

- sar - Collect, report, or save system activity information

- sar -r -n DEV -f /var/log/sa/sa16

 -n { keyword [,...] | ALL }
              Report network statistics.
              
查看网口收发数据的速率。  

对于存储节点的RoCE网卡（ 10GE组网），此命令无法查询到该网卡的收发速  
率。

https://my.oschina.net/u/4279744/blog/3881002


https://blog.csdn.net/volitationLong/article/details/81741754


### **一、重传现象的直接解读**

- **TCPLostRetransmit**: 此计数器表示：
    - **`显式触发的重传`**（如超时重传或快速重传）。
    - 值持续增长说明网络在持续丢包或延迟突变。

---

### **二、排查方向**

#### **1. 确定是否为偶发或持续问题**

```bash
# 每隔 2 秒统计一次（观察趋势）
watch -n2 "netstat -s | grep -i retrans"
```

- **偶发性增长**：可能与应用突发流量或短暂网络抖动相关。
- **持续增长**：表明存在根因（如链路故障、MTU 不匹配、硬件故障）。

---

#### **2. 关联 MTU 问题**（参考历史会话）

- **确认 MTU 一致性**：
    
    ```bash
    # 检查服务端、客户端、交换机的 MTU 配置
    ip link show eth0 | grep mtu         # Linux
    show interfaces GigabitEthernet1/1   # Cisco
    display interface GigabitEthernet0/0/1 | include MTU  # 华为
    ```
    
- **MTU 不匹配的典型影响**：引起分片（ICMP Fragmentation Needed），若 `DF` 位被设置，则直接丢包，触发 TCP 重传。

---

#### **3. 网络路径排查**

- **路径延迟和抖动**：
    
    ```bash
    # 测试到目标地址的延迟和抖动
    mtr -n -r -c 100 <目标IP>
    ```
    
- **路径丢包检测**：
    
    ```bash
    # 持续 ping 观察丢包率
    ping -c 1000 -i 0.1 <目标IP> | grep "packet loss"
    ```
    

---

#### **4. 深入分析 TCP 连接状态**

- **查看活跃连接的 RTT 和重传细节**：
    
    ```bash
    ss -ti  # 关注 `rtt` 和 `retrans`
    ```
    
- **输出示例**：
    
    ```plaintext
    ESTAB  0      0      192.168.1.100:ssh   192.168.1.2:58234
    cubic wscale:6,7 rto:234 rtt:102.3/24.3 ato:40 retrans:5
    ```
    
    - `rto`（重传超时时间）、`rtt`（往返时间）、`retrans`（该连接的重传次数）。

---

#### **5. 硬件或驱动问题**

- **检查网卡错误计数**：
    
    ```bash
    ethtool -S eth0 | grep -E "err|drop|fail"
    ```
    
    - 高 `rx/tx_errors` 或 `discards` 表明网卡或驱动异常。

---

### **三、优化和解决措施**

#### **1. 基础网络优化**

- **调整 TCP 参数**（Linux 示例）：
    
    ```bash
    # 增大 TCP 缓冲区
    sysctl -w net.ipv4.tcp_rmem='4096 87380 6291456'
    sysctl -w net.ipv4.tcp_wmem='4096 16384 4194304'
    
    # 启用 TCP 窗口缩放
    sysctl -w net.ipv4.tcp_window_scaling=1
    ```
    
- **启用 BBR 拥塞控制算法**（对抗丢包）：
    
    ```bash
    sysctl -w net.ipv4.tcp_congestion_control=bbr
    ```
    

---

#### **2. MTU 问题修复**

- 若确认 MTU 不匹配（如跨设备 MTU 不一致），需全局统一 MTU。

---

#### **3. QoS 或流量限速**

- 对关键业务流量实施优先级标记（DSCP/TOS）：
    
    ```bash
    # Linux 使用 tc 限速和优先级调度
    tc qdisc add dev eth0 root handle 1: htb
    tc class add dev eth0 parent 1: classid 1:10 htb rate 1gbit prio 0
    ```
    

---

#### **4. 替换故障硬件**

- 若网卡错误计数持续增长，尝试更换网卡或使用多网卡绑定（Bonding）。

---

### **四、高级诊断工具**

#### **1. 抓包分析重传详情**

```bash
# 抓取与目标 IP 的 TCP 流量（保存到文件）
tcpdump -i eth0 host <目标IP> and tcp -w retrans.pcap
```

- **Wireshark 分析**：
    - 过滤 `tcp.analysis.retransmission` 查看具体重传包。
    - 确认重传是 `超时重传`（间隔长）还是 `快速重传`（连续重复 ACK）。

---

#### **2. 内核跟踪工具（Linux）**

- **动态追踪重传事件**：
    
    ```bash
    perf record -e tcp:tcp_retransmit_skb -ag
    ```
    

---

### **五、总结**

| **现象**         | **可能原因**         | **优先级排查项**               |
| -------------- | ---------------- | ------------------------ |
| TCP 重传持续增长     | 网络丢包、高延迟、MTU 不匹配 | 1. 路径丢包率  <br>2. MTU 一致性 |
| 伴随机 NIC 错误计数增长 | 网卡硬件/驱动故障        | `ethtool -S` 和 dmesg 日志  |
| 仅限于特定服务        | 应用层配置或服务器性能问题    | 检查服务日志和资源占用              |

**关键点**：

1. **先区分偶发还是持续性问题**，再确定是否需要深入排查。
2. **高重传率常见于跨公网传输或无线网络环境**，若在内网中持续出现需视为严重故障。
3. **结合 MTU 配置、路径质量、硬件状态多维度分析**。