---
title: 面试必备之深入理解自旋锁
date: 2024-08-07
description: do book
draft: false
tags:
  - LINUX系统调用
categories:
  - do book
---
坚持思考，就会很酷。

大家好，这是<font color="#245bdb">进入大厂面试准备--基础知识 第4篇文章</font>，

- 知识地图：高频面试---自旋锁

## 一、面试回顾

时间：2025年 4月28 
岗位：数据库开发工程师
公司：hanxx数据库
形式：线下
面试：自己感觉回答很好，但是估计过不了

一面

基础面试：
1. 谈谈你对自旋锁理解
2. 进程通信那个方式
3. 线程局部存储
4. read,write io过程。

项目面试：
1. 干了这么多年， 你角色是什么，一个开发吗？
2. 假如入你独立开发c特性，能不能做？
3. 熟悉英语吗？开源社区 参与中文的还是英文的，英文资料行不行
4. 你学校主任是谁，
5. 在之前公司干什么事情？说的项目，结果 判断不是核心人员。（太武断了）
## 二、谈谈你对自旋锁理解


### 2.1 青铜被虐：

自旋锁是相对互斥锁而言的，

对liunx内核实现我不清楚，回答犹犹豫豫，给面试官不好印象

- 后记：没有区分角色 普通开发人员想内核开发人员事情，普通开发人员视角是什么，上来气势就输了。

根本不知道面试回答什么，大海捞针呀？
里面很多概念我哪里开始？

- 后记：你相信自己在基础知识方面我最厉害的，虽然面试无数人积累丰富经验，他们不会像我一样花费时间投入研究，让自己回答满意，自己考虑欠缺什么。

我全部回答出来了，为什么还是不满意。

- 后记：面试官也是程序员每天大量任务，面试时间一个题目给2-3分钟回答。简要回答，像汇报领导方式，让不不懂人了解核心，不是讲故事方式。
### 2.2 青铜反思：

记住这痛苦时刻，因为平时根本没有机会让自己清醒时刻


1. 工作10年和回答是刚毕业时候用法，根本不行，我面试核心岗位，一个题目价值百万，仅仅刚毕业了解回答根本不行。【太简单不行】
2. 天然的从最底层原理考虑，让自己直接吓退，也不行，面试官他们自己也没研究明白，这样回答他们不感兴趣【太难不行，都是在应用】
3. 已经回答清楚了，，面试官反问 是真的吗？或者还有呢，自己可能是错误的 还是沉迷错误继续回答，还可能是回答没问题，就是不自信，提供更多证据【面试看着要有大局观 同时关键细节把握】

必须盯住第一波攻击，谈谈xx理解，实现功能都是烟雾弹，这个三天三夜完毕，因此最后还是通用基础考察，不同追问，追问 ，在追问，如果回答不出来，马上标记pass。


划重点：看别人怎么使用技术的。

- 源头：项目中需要实现功能，Liunx已经提供了，了解他们机制。其他开源产品。
- 模仿：这些机制被不同公司包装不同产品（轮子），让用户使用，甚至提供api服务
- 应用：说自己提供xxx服务，多厉害，他们更多用户需求，更更多案例，都是基本流程，基本场景大量问题，不是自己搞一套从来没有东西。
- 我该怎么:这样自己思路豁然开朗。不是高不可攀，直接被吓退，我可以的，我可以的，我可以的.书本概念，到源码实现，到产品封装，最后解决用户问题。日常生活中出发 打破砂锅问到底。






**下面是基本思路** 

 一、这个技术出现的背景、初衷和要达到什么样的目标或是要解决什么样的问题
 二、这个技术的优势和劣势分别是什么 

 三、这个技术适用的场景。任何技术都有其适用的场景

 四、技术的组成部分和关键点。

五、技术的底层原理和关键实现

 六、已有的实现和它之间的对比




**搜集相关提问，读题目分类**

- 自旋锁和互斥锁区别  
- 自旋锁优点  
- 自旋锁永远不死锁吗
- 自旋锁和二阶信号量的差别；  
- 中断中用自旋锁还是互斥量；
- 互斥锁和自旋锁（while）哪个快？（自旋锁快）
- 临界区概念，同步技术  
- 锁知道那些？  +2
- 互斥锁和自旋锁区别 +2
- 讲一下自旋锁？+1 
- 自旋锁怎么阻止别的线程调用？+1
- 什么情况下会用自旋锁？+1
- 了解哪些锁？互斥锁 读写锁 自旋锁 自旋锁CPU高为什么还用自旋锁？
- 从零开始自己动手写自旋锁
- - 自旋锁，怎么解决多 CPU 下同时访问自旋锁的性能问题+1
- 可重入锁和自旋锁有什么区别
- volitate 底层原理 说了一些面试官不满意 +1 

### 2.3 王者归来

#### 一、这个技术出现的背景、初衷和要达到什么样的目标或是要解决什么样的问题


自旋锁 在单节点，多线程，访问公共资源，数据同步一个方式。

减少上下文切换，避免了互斥锁持操作多个资源操作不当，出现死锁情况。

自旋锁的特点是适用于锁的持有时间非常短的场景，
因为它在等待期间不会主动放弃 CPU，
而是不断尝试获取锁，
这在多核系统中可以避免由于线程调度带来的上下文切换开销


####  二、 这个技术适用的场景。任何技术都有其适用的场景



In low-level programming, busy-waits may actually be desirable. It may not be desirable or practical to implement interrupt-driven processing for every hardware device, particularly those that are seldom accessed.

Sometimes it is necessary to write some sort of control data to hardware and then fetch device status resulting from the write operation, 

status that may not become valid until a number of machine cycles have elapsed following the write
#### 技术的组成部分和关键点

小提示：
- 这地方不需要细节，例如我每天开车，需要对发动机了如指掌吗？
  不知道，只知道有什么型号发动机，让提速等关键效果就可以，陷入细节，让你根本无法说出几个特性？就这简单，有多少个？
- 需要了解是什么 ，整体统计，有哪些组成部分，别遗漏了
- 有整体统计，对自己感兴趣一个部分进行深入研究


**CAS算法** 即compare and swap（比较与交换） 无锁编程基础，
非阻塞同步（Non-blocking Synchronization）



### 2.4 总结：重要几个关键词是什么


### 五、技术的底层原理和关键实现


spinlock是最基础的一种锁，像后面将要介绍的rwlock(读写锁)，seqlock(读写锁)等都是基于spinlock衍生出来的。

就算是mutex，它的实现与spinlock也是密不可分。
因此，本系列文章将首先围绕spinlock展开介绍


**自旋锁的实现原理**
- 自旋锁的实现依赖于原子操作
- spinlock用一个整形变量表示，其初始值为1，表示available的状态。
- 当一个CPU（设为CPU A）获得spinlock后，会将该变量的值设为0
- **CAS**操作（Compare And Swap）


```C
https://github.com/torvalds/linux/blob/master/arch/sh/include/asm/spinlock-cas.h

static inline void arch_spin_lock(arch_spinlock_t *lock)
{
    while (!__sl_cas(&lock->lock, 1, 0));
}

static inline unsigned __sl_cas(volatile unsigned *p, unsigned old, unsigned new)
{
    __asm__ __volatile__("cas.l %1,%0,@r0"
        : "+r"(new)
        : "r"(old), "z"(p)
        : "t", "memory" );
    return new;
}

```

 ### 六、已有的实现和它之间的对比
 
 #####  C++ 如何实现自旋锁？

在 C/C++ 编程中, 只有 Linux`pthread` 库提供了自旋锁相关接口，而在 C++ 标准库中，并没有直接提供自旋锁（spinlock）的接口。

不过，你可以使用 `std::atomic_flag` 来实现一个简单的自旋锁，
因为 `std::atomic_flag` 是一个轻量级的原子布尔标志，非常适合构建自旋锁。


### 参考：第一手资料
1. https://en.wikipedia.org/wiki/Busy_waiting
2. 《Understanding the Linux Kernel》
3. https://zhuanlan.zhihu.com/p/534680224
4. https://zhuanlan.zhihu.com/p/89058726
5. 宋宝华： 几个人一起抢spinlock，到底谁先抢到？

#### 6. Linux中常见同步机制设计原理 
- http://www.wowotech.net/kernel_synchronization/445.html
- 摘要：

![](https://www-x-wowotech-x-net.img.addlink.cn/content/uploadfile/201806/511b1528532887.png)

##### [7] Linux中的spinlock机制[二] - MCS Lock

-  Linux中的spinlock机制[一] - CAS和ticket spinlock
- https://zhuanlan.zhihu.com/p/80727111


	如果您觉得阅读本文对您有帮助，
	请点一下“**点赞，转发**” 按钮，
	您的“**点赞，转发**” 将是我最大的写作动力！