---
title: IOçš„ä¸€ç”Ÿ
date: 2025-04-27
description: 
draft: false
tags:
  - CEPH
categories:
  - CEPH
---
å¤§å®¶å¥½æˆ‘æ˜¯å°ä¹‰åŒå­¦ï¼Œè¿™æ˜¯<font color="#00b050">å¤§å‚é¢è¯•æ‹†è§£â€”â€”é¡¹ç›®å®æˆ˜</font>ç³»åˆ—çš„ç¬¬<font color="#953734">6</font>ç¯‡æ–‡ç« ï¼Œ

â€èµ°æš—è·¯ã€è€•ç˜¦ç”°ã€è¿›çª„é—¨ã€è§å¾®å…‰â€ Â 
å‘Šè¯‰æˆ‘ Â é¢è¯•å…³é”®å°± æ·±å…¥ç†è§£è‡ªå·±é¡¹ç›® è¿™ä¸ªæ‰æ˜¯æœ€è€ƒå¯ŸåŸºæœ¬åŠŸçš„åœ°æ–¹ã€‚

çŸ¥è¯†åœ°å›¾ï¼šKVå­˜å‚¨å¼•æ“---IOæ ˆ

<font color="#245bdb">æœ¬æ–‡ ä¸»è¦æè¿° read/writeä¸ºä¾‹å­æ™®é€šæ–‡ä»¶ IOè¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</font>ï¼Œ

åˆ†æè¿™ä¸ªé—®é¢˜å…³é”®æ€è·¯åœ¨å“ªé‡Œï¼Ÿ


å¦‚æœæ‚¨è§‰å¾—é˜…è¯»æœ¬æ–‡å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œ
è¯·ç‚¹ä¸€ä¸‹â€œ**ç‚¹èµï¼Œè½¬å‘**â€ æŒ‰é’®ï¼Œ
æ‚¨çš„â€œ**ç‚¹èµï¼Œè½¬å‘**â€ å°†æ˜¯æˆ‘æœ€å¤§çš„å†™ä½œåŠ¨åŠ›ï¼

ä¸Šç¯‡æ–‡ç«  [æ–°ä¸€ä»£å­˜å‚¨å¼•æ“BlueStore,éœ€å››æ­¥](https://mp.weixin.qq.com/s/iIGui5RywsKC13daAogRJA) 

åœ¨åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ—¶å€™ï¼ŒCephçš„BlueStore ï¼Œ
1. å°†æ–‡ä»¶çš„æ•°æ®ç›´æ¥å†™å—è®¾å¤‡
2. å°†æ–‡ä»¶çš„å…ƒæ•°æ®å†™RocksDB
3. BlueStore IOæµç¨‹ å…ˆå†™æ•°æ®ï¼Œè¿˜æ˜¯å…ˆå†™å…ƒæ•°æ®é¡ºåºä¸åŒ ï¼Œæä¾›ä¸åŒç­–ç•¥ã€‚
4.  Ceph IO è½¯ä»¶æ ˆå¼€é”€åŸå›  **æ— å®ç°ä½äº 0.5 æ¯«ç§’çš„éšæœºè¯»å–å»¶è¿Ÿå’Œä½äº 1 æ¯«ç§’çš„éšæœºå†™å…¥å»¶è¿Ÿ**


æ™®é€šæ–‡ä»¶å†™æ˜¯å¦åŒºåˆ†å…ƒæ•°æ® å’Œ æ•°æ®ï¼Œè¿™äº›è¯·æ±‚æœ€åæ€ä¹ˆå†™å…¥ç£ç›˜ å‘¢ï¼Ÿ

å› ä¸ºå†…å®¹å¤ªå¤šï¼Œåˆ†æ‰¹æ¢³ç†ã€‚

å¤§çº²å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰ é¢„å¤‡çŸ¥è¯†ï¼š

![äº†è§£ç›®å‰æœ‰å“ªäº›æ–‡ä»¶ç³»ç»Ÿ](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502215215.png)

ï¼ˆ2ï¼‰ é€šè¿‡å·¥å…· äº†è§£IOæ ˆ
![IOæ ˆ](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502215326.png)
ï¼ˆ3ï¼‰ æ€§èƒ½ä¼˜åŒ–

![æ€§èƒ½ä¼˜åŒ–](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502232459.png)

## ä¸€.  å‡†å¤‡ç¯å¢ƒ 

###  1.1 æœºå™¨é…ç½®
âœ… è´­ä¹°2C2Gäº‘ä¸»æœº æˆæœ¬ä¸€å¹´ä¸è¶…è¿‡100å…ƒ

âœ… åˆ›å»º1Gçš„å¤§æ–‡ä»¶å……ä»£æ›¿å—è®¾å¤‡ï¼Œå› ä¸ºæ²¡æœ‰é¢å¤–çš„ç£ç›˜

ğŸ“Œ ä¾‹å­ï¼šç”¨ Loop è®¾å¤‡æ¨¡æ‹Ÿä¸€ä¸ª ext4 æ–‡ä»¶ç³»ç»Ÿ


```shell
# 1. åˆ›å»ºä¸€ä¸ª 1GB çš„æ™®é€šæ–‡ä»¶æ–‡ä»¶

dd if=/dev/zero of=/root/temp/virtual_disk.img bs=1M count=1024

# 2. ç»‘å®šåˆ° Loop è®¾å¤‡ï¼ˆè®© Linux è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç£ç›˜ï¼‰

losetup /dev/loop0 /root/temp/virtual_disk.img

ls -l /dev/loop0

brw-rw---- 1 root disk 7, 0 3æœˆÂ  24 13:51 /dev/loop0ã€‚


b è¡¨ç¤ºå—è®¾å¤‡æ–‡ä»¶ï¼Œ

s è¡¨ç¤ºå¥—æ¥å­— socket æ–‡ä»¶ï¼Œ

l è¡¨ç¤ºç¬¦å·é“¾æ¥

# 3. åœ¨ /dev/loop0 ä¸Šåˆ›å»º ext4 æ–‡ä»¶ç³»ç»Ÿ

mkfs.ext4 /dev/loop0


# 4. æŒ‚è½½åˆ° /mnt ç›®å½•

mkdir /mnt/icfs

		mount  /dev/loop0 /mnt/icfs  #/ordered
		
mount -o nodelallocï¼Œdata=writeback /dev/loop0 /mnt/icfs 


## æ—¥è®°(journal)ã€ é¡ºåº(ordered)å’Œ å›å†™(writeback)
##  ext4æŒ‚è½½å‚æ•°ï¼šdelallocExt4æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæ–°ç‰¹æ€§â€”â€”Delay Allocation ç¦ç”¨

# 5. å¦‚ä½•æŸ¥çœ‹å½“å‰çš„æ—¥å¿—æ¨¡å¼

5 1 é€šè¿‡dmesgå‘½ä»¤æŸ¥çœ‹Linuxç³»ç»Ÿçš„å†…æ ¸æ—¥å¿—

dmesg | grepÂ  "mounted filesystem"
EXT4-fs (vda1): mounted filesystem with ordered data mode. Opts: (null)


5.2 ç°ç£ç›˜çš„æ°¸ä¹…æŒ‚è½½  å¼€æœºå¯åŠ¨ /etc/fstab file æ£€æŸ¥

 /dev/loop0  /mnt/icfs  ext4 data=writeback 0 0

5.3  has_journal
 
dumpe2fs /dev/vda1 >1

Filesystem features:Â  Â  Â  
1 has_journal 
2 ext_attr 
3 resize_inode 
4 dir_index filetype needs_recovery extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum


1. æŸ¥çœ‹IOè°ƒåº¦å™¨

cat /sys/block/loop0/queue/scheduler
[mq-deadline] 
kyber 

bfq ï¼š
â€‹ç‰¹æ€§â€‹â€‹ï¼š
æŒ‰è¿›ç¨‹åˆ†é… I/O å¸¦å®½ï¼Œä¿éšœå¤šä»»åŠ¡å…¬å¹³æ€§
å®Œå…¨å…¬å¹³é˜Ÿåˆ—è°ƒåº¦å™¨

none 
ç‰¹æ€§â€‹â€‹ï¼šæ— è°ƒåº¦ç­–ç•¥ï¼Œç›´æ¥ä¼ é€’è¯·æ±‚åˆ°ç¡¬ä»¶å±‚
é€‚ç”¨åœºæ™¯â€‹ï¼šé«˜é€Ÿå­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ NVMe SSDï¼‰æˆ–å·²ç”±å®¿ä¸»æœºç®¡ç† I/O çš„è™šæ‹ŸåŒ–ç¯å¢ƒ

```


åˆ’é‡ç‚¹ï¼šå‚æ•°å«ä¹‰è¯´æ˜

æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„ä¸‰ç§æ—¥å¿—æ¨¡å¼ æ˜¯ä»€ä¹ˆ
- ext4æŒ‚è½½å‚æ•°: data

| Journalâ€‹**â€‹ç‰¹æ€§â€‹**â€‹ | Journal     | Orderedï¼ˆé»˜è®¤ï¼‰ | Writeback |
| ----------------- | ----------- | ----------- | --------- |
| â€‹**â€‹æ•°æ®è®°å½•â€‹**â€‹      | å…ƒæ•°æ®+æ•°æ®å‡è®°å½•æ—¥å¿— | ä»…å…ƒæ•°æ®æ—¥å¿—      | ä»…å…ƒæ•°æ®æ—¥å¿—    |
| â€‹**â€‹æ•°æ®å†™å…¥é¡ºåºâ€‹**â€‹    | ä¸¥æ ¼åŒæ­¥        | æ•°æ®å…ˆäºå…ƒæ•°æ®å†™å…¥   | æ— å¼ºåˆ¶é¡ºåº     |
| â€‹**â€‹æ€§èƒ½â€‹**â€‹        | æœ€ä½          | ä¸­ç­‰          | æœ€é«˜        |
| â€‹**â€‹å´©æºƒæ¢å¤â€‹**â€‹      | å®Œå…¨ä¸€è‡´        | æ•°æ®å¯èƒ½éƒ¨åˆ†ä¸¢å¤±    | æ•°æ®å¯èƒ½å¤§é‡ä¸¢å¤±  |
| â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹      | æ•°æ®åº“ã€å…³é”®ä¸šåŠ¡    | æœåŠ¡å™¨ã€æ—¥å¸¸åŠå…¬    | é«˜æ€§èƒ½è®¡ç®—     |
 
- IfÂ `data=writeback`, dirty data blocks are not flushed to the disk before the metadata are written to disk through the journal.
- å†…æ ¸æœ‰ä¸“é—¨çš„æœºåˆ¶è´Ÿè´£å°†é¡µç¼“å­˜ä¸­çš„æ•°æ®**å¼‚æ­¥åœ°**å†™å…¥ç£ç›˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º**å†™å›ï¼ˆwritebackï¼‰**ã€‚

| å»¶è¿Ÿåˆ†é…â€‹**â€‹åœºæ™¯â€‹**â€‹   | â€‹**â€‹æ¨èé€‰é¡¹â€‹**â€‹ | â€‹**â€‹åŸå› â€‹**â€‹                           |
| ---------------- | ------------ | ------------------------------------ |
| â€‹**â€‹é«˜ååé‡é¡ºåºå†™å…¥â€‹**â€‹ | `delalloc`   | åˆ©ç”¨æ‰¹é‡åˆ†é…ä¼˜åŒ–è¿ç»­å†™å…¥æ€§èƒ½ï¼ˆå¦‚æ—¥å¿—æœåŠ¡å™¨ã€å¤§æ•°æ®å¤„ç†ï¼‰<br><br> |
| â€‹**â€‹ä½å»¶è¿Ÿå…³é”®ä¸šåŠ¡â€‹**â€‹  | `nodelalloc` | é¿å…å•æ¬¡å†™å…¥å»¶è¿Ÿæ³¢åŠ¨ï¼ˆå¦‚æ•°æ®åº“äº‹åŠ¡ã€å®æ—¶ç³»ç»Ÿï¼‰<br>          |

### 2.1 å—è®¾å¤‡IOè·Ÿè¸ª

```c
#Â å®‰è£…blktraceåŒ…
sudo yum install blktrace

# blktraceåŒ…å®‰è£…åæœ‰blktraceã€blkparseã€bttã€blkiomonè¿™4ä¸ªå‘½ä»¤
#blktraceè´Ÿè´£é‡‡é›†I/Oäº‹ä»¶æ•°æ®ï¼Œ
# blkparseè´Ÿè´£å°†æ¯ä¸€ä¸ªI/Oäº‹ä»¶æ•°æ®è§£æä¸ºçº¯æ–‡æœ¬æ–¹ä¾¿é˜…è¯»ï¼Œ
## bttã€blkiomonè´Ÿè´£ç»Ÿè®¡åˆ†æ

#Â blktraceä¾èµ–debugfsï¼Œéœ€è¦æŒ‚è½½å®ƒ  
sudo mount -t debugfs none /sys/kernel/debug
## debugfs æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ä¸ªä¸“ç”¨æ–‡ä»¶ç³»ç»Ÿï¼ŒåŠ¨æ€åˆ›å»ºã€æ— éœ€é‡æ–°ç¼–è¯‘å†…æ ¸
éªŒè¯
lsÂ /sys/kernel/debug/
mount | grep debugfsÂ 

debugfs on /sys/kernel/debug type debugfs (rw,relatime)

dd if=/dev/zero of=/mnt/icfs/test bs=1k count=16

blktrace -d /dev/loop0 -o - |blkparse -i -


```


ä¸€ã€å­—æ®µå«ä¹‰ä¸äº‹ä»¶é“¾åˆ†æ
1. â€‹**â€‹å­—æ®µè§£æâ€‹**â€‹ï¼ˆå‚è€ƒç¤ºä¾‹è¡Œï¼š`7,0 1 226 52.043115656 3815652 Q WS 1104864 +8 [jbd2/loop0-8]`ï¼‰
    - â€‹**â€‹7,0â€‹**â€‹ï¼šè®¾å¤‡å·ï¼ˆä¸»è®¾å¤‡å·:æ¬¡è®¾å¤‡å·ï¼‰ï¼Œè¡¨ç¤ºÂ `/dev/loop0`ï¼ˆè™šæ‹Ÿå—è®¾å¤‡ï¼‰ã€‚
    - â€‹**â€‹1â€‹**â€‹ï¼šCPU æ ¸ç¼–å·ï¼ˆæ­¤å¤„ä¸º CPU 1ï¼‰ã€‚
    - â€‹**â€‹226â€‹**â€‹ï¼šäº‹ä»¶åºåˆ—å·ã€‚
    - â€‹**â€‹52.043115656â€‹**â€‹ï¼šæ—¶é—´æˆ³ï¼ˆç§’çº§ç²¾åº¦ï¼‰ã€‚
    - â€‹**â€‹3815652â€‹**â€‹ï¼šè¿›ç¨‹ PIDï¼ˆjbd2 å†…æ ¸çº¿ç¨‹ï¼‰ã€‚
    - â€‹**â€‹Q/WSâ€‹**â€‹ï¼šäº‹ä»¶ç±»å‹ï¼ˆQ=è¯·æ±‚è¿›å…¥é˜Ÿåˆ—ï¼ŒWS=å†™åŒæ­¥æ“ä½œï¼‰ã€‚
    - â€‹**â€‹1104864 +8â€‹**â€‹ï¼šèµ·å§‹å—å·Â `1104864`ï¼Œæ“ä½œå¤§å°Â `8`Â ä¸ªå—ï¼ˆé€šå¸¸ 1 å—=4KBï¼Œå³ 32KB å†™æ“ä½œï¼‰ã€‚
    - â€‹**â€‹[jbd2/loop0-8]â€‹**â€‹ï¼šè¿›ç¨‹åï¼Œè¡¨ç¤ºÂ `jbd2`Â çº¿ç¨‹ç®¡ç†Â `/dev/loop0`Â è®¾å¤‡çš„æ—¥å¿—åŠŸèƒ½ã€‚
2. â€‹**â€‹äº‹ä»¶é“¾åˆ†æâ€‹**â€‹ï¼ˆå…³é”®é˜¶æ®µï¼‰
    - â€‹**â€‹Qâ†’G é˜¶æ®µâ€‹**â€‹ï¼ˆè¯·æ±‚ç”Ÿæˆï¼‰ï¼š  
        ç¤ºä¾‹ï¼š`Q WS 1104864 +8`Â â†’Â `G WS 1104864 +8`  
        è¡¨ç¤º I/O è¯·æ±‚è¿›å…¥å—å±‚ååˆ†é…Â `request`Â ç»“æ„ä½“ï¼ˆè€—æ—¶çº¦å¾®ç§’çº§ï¼‰ã€‚
    - â€‹**â€‹I é˜¶æ®µâ€‹**â€‹ï¼ˆæ’å…¥è°ƒåº¦å™¨é˜Ÿåˆ—ï¼‰ï¼š  
        å¤šè¡ŒÂ `I WS`Â äº‹ä»¶æ˜¾ç¤ºè¯·æ±‚è¢«æ’å…¥ I/O è°ƒåº¦å™¨é˜Ÿåˆ—ï¼ˆå¦‚Â `mq-deadline`ï¼‰ã€‚
    - â€‹**â€‹D é˜¶æ®µâ€‹**â€‹ï¼ˆä¸‹å‘åˆ°é©±åŠ¨ï¼‰ï¼š  
        `D WS`Â è¡¨ç¤ºè¯·æ±‚è¢«å‘é€è‡³è®¾å¤‡é©±åŠ¨å±‚ï¼Œè¿›å…¥ç‰©ç†è®¾å¤‡å¤„ç†ã€‚
    - â€‹**â€‹U/FN é˜¶æ®µâ€‹**â€‹ï¼š  
        `U N`Â è¡¨ç¤ºé˜Ÿåˆ—è§£ç»‘æ“ä½œï¼›`D FN`Â å¯èƒ½æ¶‰åŠå±éšœï¼ˆBarrierï¼‰æˆ–åˆ·æ–°æ“ä½œã€‚


```shell
  
jbd2 è¿›ç¨‹è´Ÿè´£ ext4 æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—æäº¤æ“ä½œã€‚

echo 1 > /sys/kernel/debug/tracing/events/ext4/ext4_sync_file_enter/enable
echo 1 > /sys/kernel/debug/tracing/events/jbd2/jbd2_commit_flushing/enable

Â Â  Â  barad_agent-621691Â  [000] .... 16365334.481433: ext4_sync_file_enter: dev 253,1 ino 922856 parent 927477 datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  [000] .... 16365334.482411: jbd2_commit_flushing: dev 253,1 transaction 23610801 sync 0

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.485209: ext4_sync_file_enter: dev 253,1 ino 922856 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.485976: ext4_sync_file_enter: dev 253,1 ino 923617 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.488730: ext4_sync_file_enter: dev 253,1 ino 928166 parent 927477 datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  [001] .... 16365334.489345: jbd2_commit_flushing: dev 253,1 transaction 23610802 sync 0

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.492786: ext4_sync_file_enter: dev 253,1 ino 928166 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.493294: ext4_sync_file_enter: dev 253,1 ino 923617 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.494829: ext4_sync_file_enter: dev 253,1 ino 922856 parent 927477 datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  [000] .... 16365334.495552: jbd2_commit_flushing: dev 2


strace -c -f -e trace=file,sync,fsync,fdatasync -p 20949

jbd2 çº¿ç¨‹ä¸ Linux é€šç”¨å—å±‚ç´§å¯†åä½œï¼š
ä»æ„é€  BIOã€

è°ƒç”¨ `submit_bio()`ã€

ä¾èµ–å—å±‚çš„åˆå¹¶ä¸è°ƒåº¦ï¼Œ
åˆ°æ¥æ”¶ `bio_end_io` å›è°ƒï¼Œ

å½¢æˆäº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„ã€å…·å¤‡é«˜ä¼˜å…ˆçº§ä¿éšœçš„æ—¥å¿—å†™å…¥é€šé“ï¼Œ
ç¡®ä¿ ext4/ext3 æ–‡ä»¶ç³»ç»Ÿåœ¨å´©æºƒæ¢å¤æ—¶èƒ½å¤Ÿå¿«é€Ÿä¸”å¯é åœ°å›æ”¾ä¸æäº¤äº‹åŠ¡ã€‚

```
### 2.3ä»å—å±‚é¢ IOä¼˜åŒ–



## äºŒ.  IOæ ˆå…¨æ™¯å›¾

- https://www.thomas-krenn.com/de/wikiDE/images/e/e8/Linux-storage-stack-diagram_v6.9.png

![image.png](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502165459.png)


ä¸ºäº†æŒæ¡IOæ ˆå¿…é¡»äº†è§£çš„åŸºæœ¬çŸ¥è¯†

- ä»€ä¹ˆæ˜¯è™šæ‹Ÿå†…å­˜ï¼Œä¸ç£ç›˜æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ è¿™ä¸ªæ˜¯äº†è§£ å—è®¾å¤‡bioå±‚åŸºç¡€

![â€”ä¸ª VM ç³»ç»Ÿæ˜¯å¦‚ä½•ä½¿ç”¨ä¸»å­˜ä½œä¸ºç¼“å­˜](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502163052.png)
å®ƒå°†ä¸»å­˜çœ‹æˆæ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„åœ°å€ç©ºé—´çš„ é«˜é€Ÿç¼“å­˜ï¼Œ
åœ¨ä¸»å­˜ä¸­åªä¿å­˜æ´»åŠ¨åŒºåŸŸï¼Œ
å¹¶æ ¹æ®éœ€è¦åœ¨ç£ç›˜å’Œä¸»å­˜ä¹‹é—´æ¥å›ä¼ é€æ•°æ®ï¼Œ
é€šè¿‡ è¿™ç§æ–¹å¼ï¼Œå®ƒé«˜æ•ˆåœ°ä½¿ç”¨äº†ä¸»å­˜

åœ¨ä»»æ„æ—¶åˆ»ï¼Œè™šæ‹Ÿé¡µé¢çš„é›†åˆéƒ½åˆ†ä¸ºä¸‰ä¸ªä¸ç›¸äº¤çš„å­é›†ï¼š
â€¢æœªåˆ†é…çš„ï¼šVM ç³»ç»Ÿè¿˜æœªåˆ†é…(æˆ–è€…åˆ›å»ºï¼‰çš„é¡µã€‚
æœªåˆ†é…çš„å—æ²¡æœ‰ä»»ä½•æ•°æ®å’Œå®ƒä»¬ç›¸ å…³è”ï¼Œå› æ­¤ä¹Ÿå°±ä¸å ç”¨ä»»ä½•ç£ç›˜ç©ºé—´ã€‚ 
â€¢ç¼“å­˜çš„ï¼šå½“å‰å·²ç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µã€‚
â€¢æœªç¼“å­˜çš„ï¼šæœªç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µ

- åœ°å€ç©ºé—´ï¼ˆaddress space)æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°åœ°å€çš„æœ‰åºé›†åˆã€åœ°å€å’Œæ•°æ®å…³ç³»ã€‘
- â€”ä¸ª VM ç³»ç»Ÿæ˜¯å¦‚ä½•ä½¿ç”¨ä¸»å­˜ä½œä¸ºç¼“å­˜
- åœ¨è™šæ‹Ÿå†…å­˜çš„ä¹ æƒ¯è¯´æ³•ä¸­ï¼ŒDRAM ç¼“å­˜ä¸å‘½ä¸­ç§°ä¸ºç¼ºé¡µï¼ˆpage fault)
- åœ¨ç£ç›˜å’Œå†…å­˜ä¹‹é—´ä¼ é€é¡µçš„æ´» åŠ¨å«åšäº¤æ¢ï¼ˆswapping)æˆ–è€…é¡µ é¢è°ƒåº¦ï¼ˆpaging)ã€‚é¡µä»ç£ç›˜æ¢å…¥ï¼ˆæˆ–è€…é¡µé¢è°ƒå…¥ï¼‰DRAM å’Œä» DRAM æ¢å‡ºï¼ˆæˆ–è€…é¡µé¢è°ƒå‡ºï¼‰ç£ç›˜ã€‚

- ![Linux kernel Block I/O Layer](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502174539.png)


## ä¸‰ã€IOæ€§èƒ½ä¼˜åŒ–é‡‡ç”¨æ‰‹æ®µ



## å‚è€ƒèµ„æ–™
### 1 Linuxé—®é¢˜åˆ†æä¸æ€§èƒ½ä¼˜åŒ–
- åœ°å€ï¼šhttps://mp.weixin.qq.com/s/ZDq5_bVGidW1UcPI2TpRb
### 2 æ·±å…¥ç†è§£ Linuxçš„ I/O ç³»ç»Ÿ
- https://zhuanlan.zhihu.com/p/435029164
### 3  EXT4
- https://blog.csdn.net/wmzjzwlzs/article/details/143608926
- ä¸€æ¬¡ write ç³»ç»Ÿè°ƒç”¨ç«Ÿç„¶æ¶ˆè€—äº† 147msï¼Œå¾ˆæ˜æ˜¾åœ°ï¼Œé—®é¢˜å‡ºåœ¨ write ç³»ç»Ÿè°ƒç”¨ä¸Šã€‚
- **çŒœæµ‹å› ä¸º journal è§¦å‘äº†è„é¡µè½ç›˜ï¼Œè€Œè„é¡µè½ç›˜å¯¼è‡´ write è¢«é˜»å¡ï¼Œæ‰€ä»¥è§£å†³ journal é—®é¢˜å°±å¯ä»¥è§£å†³æ¥å£è¶…æ—¶é—®é¢˜ã€‚
- https://oenhan.com/rwsem-realtime-task-hung é—®é¢˜ç»ˆäºå¤„ç†æ¸…æ¥šäº†ï¼Œå¦‚æ­¤å‘çˆ¹çš„é—®é¢˜ï¼Œé™†é™†ç»­ç»­çš„æäº†æœ‰è¿‘æœˆçš„æ—¶é—´
- > å»¶è¿Ÿåˆ†é…(delayed allocation)ï¼šext4 æ–‡ä»¶ç³»ç»Ÿåœ¨åº”ç”¨ç¨‹åºè°ƒç”¨ write system call æ—¶å¹¶ä¸ä¸ºç¼“å­˜é¡µé¢åˆ†é…å¯¹åº”çš„ç‰©ç†ç£ç›˜å—ï¼Œå½“æ–‡ä»¶çš„ç¼“å­˜é¡µé¢çœŸæ­£è¦è¢«åˆ·æ–°è‡³ç£ç›˜ä¸­æ—¶ï¼Œæ‰ä¼šä¸ºæ‰€æœ‰æœªåˆ†é…ç‰©ç†ç£ç›˜å—çš„é¡µé¢ç¼“å­˜åˆ†é…å°½é‡è¿ç»­çš„ç£ç›˜å—ã€‚
- https://man7.org/linux/man-pages/man5/ext4.5.html
-  **nodelalloc**
              Disable delayed allocation. Blocks are allocated when data
              is copied from user to page cache.
- æ—¥å‰çº¿ä¸Šåœ¨å‡çº§åˆ°Ext4æ–‡ä»¶ç³»ç»Ÿåå‡ºç°åº”ç”¨å†™æ“ä½œå»¶è¿Ÿå¼€é”€å¢å¤§çš„é—®é¢˜ã€‚é€ æˆè¿™ä¸€é—®é¢˜çš„æ ¹æºç›®å‰å·²ç»æŸ¥æ˜ï¼Œæ˜¯ç”±äºExt4æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæ–°ç‰¹æ€§â€”â€”Delay Allocationé€ æˆçš„ã€‚ï¼ˆåé¢ç®€ç§°delallocï¼‰
- ```
delalloc:
lat (usec): min=2 , max=193466 , avg= 5.86, stdev=227.91

nodelalloc:


### 4  æ‰“é€šIOæ ˆï¼šä¸€æ¬¡ç¼–è¯‘æœåŠ¡å™¨æ€§èƒ½ä¼˜åŒ–å®æˆ˜

- é€šè¿‡é€šç”¨å—å±‚æŠŠé¡µç¼“å­˜é‡Œçš„æ•°æ®å›åˆ·åˆ°ç£ç›˜ä¸­
- bioå±‚è®°å½•äº†ç£ç›˜å—ä¸å†…å­˜é¡µä¹‹é—´çš„å…³ç³»
- åœ¨requestå±‚æŠŠå¤šä¸ªç‰©ç†å—è¿ç»­çš„bioåˆå¹¶æˆä¸€ä¸ªrequest
- # Linuxé˜…ç åœºåŸåˆ›ç²¾åæ–‡ç« æ±‡æ€»
https://www.cnblogs.com/sky-heaven/p/15987836.html
- æ–‡ä»¶ç³»ç»Ÿå’ŒIO
- # å®‹å®åï¼š æ–‡ä»¶è¯»å†™ï¼ˆBIOï¼‰æ³¢æ¾œå£®é˜”çš„ä¸€ç”Ÿ
ç½‘ä¸Šå…³äºBIOå’Œå—è®¾å¤‡è¯»å†™æµç¨‹çš„æ–‡ç« ä½•æ­¢åƒä¸‡ï¼Œä½†æ˜¯èƒ½å¤Ÿè®©ä½ å½»åº•è¯»æ‡‚è¯»æ˜ç™½çš„æ–‡ç« å®åœ¨éš¾æ‰¾ï¼Œå¯ä»¥è¯´æ˜¯è¶Šè¯»è¶Šç³Šæ¶‚ï¼  

æˆ‘æ›¾ç»è·¨è¿‡å±±å’Œå¤§æµ· ä¹Ÿç©¿è¿‡äººå±±äººæµ·

æˆ‘æ›¾ç»é—®éæ•´ä¸ªä¸–ç•Œ ä»æ¥æ²¡å¾—åˆ°ç­”æ¡ˆ
æœ¬æ–‡çš„å†™ä½œå®—æ—¨æ˜¯ï¼šç»ä¸è£…é€¼ï¼Œä¸€å®šè¦ç®€å•ï¼Œç®€å•ï¼Œå†ç®€å•ï¼

åœ¨Linuxé‡Œé¢ï¼Œç”¨äºæè¿°ç¡¬ç›˜é‡Œé¢è¦çœŸå®æ“ä½œçš„ä½ç½®ä¸page cacheçš„é¡µæ˜ å°„å…³ç³»çš„æ•°æ®ç»“æ„æ˜¯bioã€‚ç›¸ä¿¡å¤§å®¶å·²ç»è§åˆ°bioä¸€ä¸‡æ¬¡s

æŠŠbioè½¬åŒ–ä¸ºrequestï¼ŒæŠŠrequestæ”¾å…¥è¿›ç¨‹æœ¬åœ°çš„plugé˜Ÿåˆ—ï¼›è“„åŠ¿å¤šä¸ªrequeståï¼Œå†è¿›è¡Œæ³„æ´ªã€‚

### ã€ã€‘å­¦ä¹ bioè®¡åˆ’



æœ¬è®¡åˆ’ä»¥ 8 å‘¨ä¸ºæœŸï¼Œåˆ†é˜¶æ®µç”±æµ…å…¥æ·±ï¼Œç»“åˆ**æ–‡æ¡£å­¦ä¹ **ã€**æºç é˜…è¯»**ä¸**åŠ¨æ‰‹å®è·µ**ã€‚

---

å‰æœŸå‡†å¤‡ï¼ˆç¬¬Â 0Â å‘¨ï¼‰

- **ç¯å¢ƒæ­å»º**ï¼šå‡†å¤‡ä¸€å°å¯åˆ·å†™å†…æ ¸çš„æµ‹è¯•æœºæˆ–è™šæ‹Ÿæœºï¼Œå®‰è£…å¸¸ç”¨å¼€å‘å·¥å…·ï¼ˆ`git`ã€`make`ã€`gcc`ã€`perf`ã€`blktrace` ç­‰ï¼‰ã€‚
    
- **åŸºç¡€çŸ¥è¯†å›é¡¾**ï¼š
    
    - é˜…è¯» Linux å—è®¾å¤‡å±‚æ¦‚è§ˆã€Cornell æ•™æã€‘([è®¡ç®—æœºç§‘å­¦ç³»](https://www.cs.cornell.edu/courses/cs4410/2021fa/assets/material/lecture24_blk_layer.pdf?utm_source=chatgpt.com "[PDF] Linux kernel Block I/O Layer"))
        
    - ç†Ÿæ‚‰é¡µç¼“å­˜ä¸ç”Ÿç‰©ï¼ˆbioï¼‰æ¨¡å‹ï¼š`struct bio`ã€`submit_bio()` æµç¨‹ã€HackMD è®²è§£ã€‘([HackMD](https://hackmd.io/%40ztex/SJaMGhjfD?utm_source=chatgpt.com "Block device, BIO in linux kernel - HackMD"))
        

---
 é˜¶æ®µÂ 1ï¼šBio ä¸ Request å±‚ï¼ˆç¬¬Â 1â€“2Â å‘¨ï¼‰

### å­¦ä¹ ç›®æ ‡

- ç†è§£ bio å¦‚ä½•æ˜ å°„åˆ°é¡µç¼“å­˜ä¸ç£ç›˜å—
- æŒæ¡ `struct bio` ä¸ `struct request` çš„å…³ç³»
### å®è·µä»»åŠ¡

1. ç”¨ `printk` æˆ– ftrace æ‰“ç‚¹ `submit_bio()` ä¸ `generic_make_request()` è·¯å¾„ã€‚
    
2. ç¼–å†™ä¸€ä¸ªç®€å•çš„ RAM-disk é©±åŠ¨ï¼ˆ`blk_queue_make_request`ï¼‰å¹¶è§‚å¯Ÿ bio åˆ° request å±‚çš„æµè½¬ã€‚
    

---
 é˜¶æ®µÂ 2ï¼šI/O è°ƒåº¦å™¨æºç ç ”è¯»ï¼ˆç¬¬Â 3â€“4Â å‘¨ï¼‰

### å­¦ä¹ ç›®æ ‡

- æ·±å…¥é˜…è¯» `block/elevator.c`ï¼Œç†è§£åˆå¹¶é€»è¾‘ï¼š
    - `elv_bio_merge_ok()`ï¼šåˆ¤æ–­ bio ä¸ request æ˜¯å¦å¯åˆå¹¶
        
    - `elv_merge()`ã€`elv_attempt_insert_merge()`ã€`elv_merged_request()`ã€`elv_merge_requests()` ç­‰å‡½æ•°
        

### å­¦ä¹ èµ„æº

- **GitHub ä¸Šçš„ `elevator.c`**ï¼šæœ€æ–°å†…æ ¸æºç ([GitHub](https://github.com/torvalds/linux/blob/master/block/elevator.c?utm_source=chatgpt.com "linux/block/elevator.c at master Â· torvalds/linux - GitHub"), [Android Git Repositories](https://android.googlesource.com/kernel/common/%2B/refs/tags/ASB-2019-02-05_4.19/block/elevator.c?utm_source=chatgpt.com "block/elevator.c - kernel/common - Git at Google"))
    
- **Android Git æº**ï¼šå«æ³¨é‡Šçš„ `elv_bio_merge_ok` å®ç°([Android Git Repositories](https://android.googlesource.com/kernel/common/%2B/baa23246e93f/block/elevator.c?utm_source=chatgpt.com "block/elevator.c - kernel/common - Git at Google
    ```
    

---
 é˜¶æ®µÂ 3ï¼šæ·±åº¦è·Ÿè¸ªä¸æ€§èƒ½åˆ†æï¼ˆç¬¬Â 5â€“6Â å‘¨ï¼‰

### å­¦ä¹ ç›®æ ‡

- æŒæ¡ `blktrace`ã€`blkparse` ä¸ `btt` çš„ç”¨æ³•
- åˆ†æ I/O ç”Ÿå‘½å‘¨æœŸï¼Œè¯†åˆ«è°ƒåº¦ä¸è®¾å¤‡ç“¶é¢ˆ
### å­¦ä¹ èµ„æº

- **Medium å®æˆ˜æ•™ç¨‹**ï¼š`blktrace` åŸºæœ¬ç”¨æ³•ä¸ç¤ºä¾‹([Medium](https://medium.com/%40bilsted/i-o-tracing-with-blktrace-72a1b6f092f8?utm_source=chatgpt.com "I/O tracing with blktrace - Medium"))
    https://bean-li.github.io/blktrace-to-report/
Q â€“ å³å°†ç”ŸæˆIOè¯·æ±‚ | G â€“ IOè¯·æ±‚ç”Ÿæˆ | I â€“ IOè¯·æ±‚è¿›å…¥IO Scheduleré˜Ÿåˆ— | D â€“ IOè¯·æ±‚è¿›å…¥driver |
- **Brooker åšæ–‡**ï¼šè¶…è¶Š `iostat` çš„å­˜å‚¨åˆ†æ([brooker.co.za](https://brooker.co.za/blog/2013/07/14/io-performance.html?utm_source=chatgpt.com "Beyond iostat: Storage performance analysis with blktrace"))
    
- **RedÂ Hat æ€§èƒ½è°ƒä¼˜æŒ‡å—**ï¼š`btt` æ·±åº¦åˆ†ææ–¹æ³•([çº¢å¸½æ–‡æ¡£](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-red_hat_enterprise_linux-performance_tuning_guide-storage_and_file_systems-monitoring_and_diagnosing_performance_problems?utm_source=chatgpt.com "8.2. Monitoring and Diagnosing Performance Problems | Red Hat ..."))
    

### å®è·µä»»åŠ¡

1. å¯¹æ¯”ä¸åŒè°ƒåº¦ç­–ç•¥ï¼ˆ`noop`/`deadline`/`cfq`ï¼‰ä¸‹çš„è·Ÿè¸ªç»“æœï¼š
    
    ```bash
    blktrace -d /dev/sda -o - | blkparse -i -
    btt -i trace.blktrace.*.0 | less
    ```
    
2. é€šè¿‡ `Q`,`I`,`D`,`C` äº‹ä»¶æ—¶åºï¼Œåˆ¤æ–­è°ƒåº¦ä¸é©±åŠ¨å»¶è¿Ÿæ‰€åœ¨ï¼Œå¹¶è¾“å‡ºå¯è§†åŒ–æŠ¥å‘Šã€‚
    
3. è°ƒæ•´ `elevator`ï¼ˆ`cat /sys/block/sda/queue/scheduler`ï¼‰ï¼Œé‡æ–°è·Ÿè¸ªéªŒè¯ã€‚
    

---
 é˜¶æ®µÂ 4ï¼šå¤šé˜Ÿåˆ—ä¸è‡ªå®šä¹‰é©±åŠ¨ï¼ˆç¬¬Â 7â€“8Â å‘¨ï¼‰

### å­¦ä¹ ç›®æ ‡

- ç†è§£å¹¶ä½¿ç”¨å¤šé˜Ÿåˆ—å—å±‚ï¼ˆblk-mqï¼‰
    
- åœ¨é©±åŠ¨ä¸­è‡ªå®šä¹‰ `make_request_fn` æˆ–è¿ç§»è‡³ blk-mq æ¥å£

### å­¦ä¹ èµ„æº

- **Kernel.org æ–‡æ¡£**ï¼šblk-mq åŸç†ä¸ API([Linuxå†…æ ¸æ–‡æ¡£](https://docs.kernel.org/block/blk-mq.html?utm_source=chatgpt.com "Multi-Queue Block IO Queueing Mechanism (blk-mq)"), [å†…æ ¸.org](https://www.kernel.org/doc/html/v5.11/block/blk-mq.html?utm_source=chatgpt.com "Multi-Queue Block IO Queueing Mechanism (blk-mq)"))
    
- **ThomasÂ Krenn Wiki**ï¼šblk-mq æ€§èƒ½åˆ†æ([Thomas-Krenn.AG](https://www.thomas-krenn.com/en/wiki/Linux_Multi-Queue_Block_IO_Queueing_Mechanism_%28blk-mq%29_Details?utm_source=chatgpt.com "Linux Multi-Queue Block IO Queueing Mechanism (blk-mq) Details"))
    
- **ç¤¾åŒºè®¨è®º**ï¼šå¦‚ä½•åœ¨ 6.x ä¸Šæ‰©å±• `make_request_fn`ï¼ˆdattobd/submit_bioï¼‰([Reddit](https://www.reddit.com/r/kernel/comments/13oh2lu/block_filter_driver_for_kernel_6x/?utm_source=chatgpt.com "Block filter driver for kernel 6.x - Reddit"))
    

### å®è·µä»»åŠ¡

1. åœ¨æ”¯æŒå¤šé˜Ÿåˆ—çš„è®¾å¤‡ä¸Šå¯ç”¨ blk-mqï¼ˆæ£€æŸ¥ `QUEUE_FLAG_MQ_PCI` ç­‰æ ‡å¿—ï¼‰ã€‚
    
2. å°†ç¤ºä¾‹é©±åŠ¨æ”¹ä¸º `blk_mq_alloc_sq_tags()` + `blk_mq_queue` æ¨¡å¼ï¼Œå®ç° per-CPU è½¯ä»¶é˜Ÿåˆ—ã€‚
    
3. ä½¿ç”¨ `perf` åˆ†æå¤šé˜Ÿåˆ—ä¸‹çš„ä¸­æ–­ä¸ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œä¼˜åŒ– `tag_set` é…ç½®ã€‚
    

---
 å¦‚ä½•è¯„ä¼°è¿›é˜¶ï¼å¤§å¸ˆæ°´å¹³

- **ä»£ç é˜…è¯»**ï¼šèƒ½åœ¨ â‰¥â€¯30â€¯åˆ†é’Ÿå†…å®šä½å¹¶è®²è§£ `elv_bio_merge_ok()`ã€`blk_try_merge()` ç­‰æ ¸å¿ƒç‚¹ï¼›
    
- **å‚æ•°è°ƒä¼˜**ï¼šç†Ÿç»ƒä½¿ç”¨ `nomerges`ã€`nr_requests`ã€`scheduler` ç­‰å¹¶åœ¨çœŸå®åœºæ™¯ä¸­ç»™å‡ºåˆç†é…ç½®ï¼›
    
- **è·Ÿè¸ªåˆ†æ**ï¼šç”¨ `blktrace`/`btt` è¾“å‡ºç“¶é¢ˆæŠ¥å‘Šï¼Œå¹¶æå‡ºæ”¹è¿›æ–¹æ¡ˆï¼›
    
- **é©±åŠ¨å¼€å‘**ï¼šå®Œæˆä¸€ä¸ªæ”¯æŒ blk-mq çš„è‡ªå®šä¹‰å—é©±åŠ¨ï¼Œç¡®ä¿åœ¨é«˜å¹¶å‘ I/O ä¸‹ç¨³å®šä¸”æ€§èƒ½ä¼˜è‰¯ã€‚
    

é€šè¿‡ä»¥ä¸Šç³»ç»ŸåŒ–ã€é˜¶æ¢¯åŒ–çš„å­¦ä¹ ä¸å®è·µï¼Œä½ å°†ä»â€œæ–°æ‰‹â€é€æ­¥æ™‹çº§è‡³çœŸæ­£çš„â€œå—å±‚ I/O å¤§å¸ˆâ€ã€‚ç¥å­¦ä¹ é¡ºåˆ©ï¼

### 5. èµ„æ–™ The Linux Process Journey â€” â€œjbd2â€
- â€œJBDâ€ stands for â€œJournal Block Device
- https://elixir.bootlin.com/linux/v6.2.1/source/fs/jbd2/journal.c#L277
- https://elixir.bootlin.com/linux/v6.2.1/source/fs/jbd2/journal.c#L152
- An Introduction to the Linux Kernel Block I/O Stack
- Device-Mapperï¼ˆdmï¼‰å’Œ Linux è½¯ä»¶ RAIDï¼ˆmdï¼‰éƒ½æ˜¯åŸºäºè™šæ‹Ÿå—è®¾å¤‡ï¼ˆstacked block deviceï¼‰çš„æ ¸å¿ƒæŠ€æœ¯
-  Linux å†…æ ¸ä¸­çš„ Device Mapper æœºåˆ¶
- LVM2æ˜¯Linux ä¸‹çš„é€»è¾‘å·ç®¡ç†å™¨ï¼Œå®ƒå¯ä»¥å¯¹ç£ç›˜è¿›è¡Œåˆ†åŒºç­‰ã€‚ä½†æ˜¯æˆ‘ä»¬è¿™é‡Œç”¨LVMä¸»è¦æ˜¯åˆ©ç”¨ç”¨æˆ·ç©ºé—´çš„device mapper åº“ä»¥åŠå®ƒæä¾›çš„ dmsetup å·¥å…·
- é€šè¿‡ä½¿ç”¨ LVM æ ‡è®°ï¼ŒÂ `lvm`Â å­å‘½ä»¤èƒ½å¤Ÿé€šè¿‡æŸ¥è¯¢ä¸ OSD å…³è”çš„è®¾å¤‡æ¥å­˜å‚¨å’Œé‡æ–°å‘ç°è¿™äº›è®¾å¤‡ï¼Œä»¥ä¾¿å¯ä»¥æ¿€æ´»è¿™äº›è®¾å¤‡ã€‚ è¿™è¿˜åŒ…æ‹¬å¯¹åŸºäº lvm çš„æŠ€æœ¯ (ä¾‹å¦‚Â `dm-cache`Â ) çš„æ”¯æŒã€‚
- è™šæ‹Ÿå—è®¾å¤‡ï¼ˆstacked block deviceï¼‰
- Â æ˜¯é€šè¿‡ä¿¡å·å®Œæˆå¼‚æ­¥é€šçŸ¥çš„å—ï¼Ÿ

| â€‹**â€‹ç‰¹æ€§â€‹**â€‹   | â€‹**â€‹å†…æ ¸ä¸­æ–­+å›è°ƒæœºåˆ¶â€‹**â€‹ | â€‹**â€‹ç”¨æˆ·æ€ä¿¡å·ï¼ˆå¦‚ SIGIOï¼‰â€‹**â€‹         |
| ------------ | ----------------- | ------------------------------ |
| â€‹**â€‹è§¦å‘æºâ€‹**â€‹  | ç¡¬ä»¶ä¸­æ–­ï¼ˆIRQï¼‰         | å†…æ ¸å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼ˆå¦‚Â `fcntl(F_NOTIFY)`ï¼‰ |
| â€‹**â€‹å»¶è¿Ÿâ€‹**â€‹   | å¾®ç§’çº§ï¼ˆç›´æ¥ç”±ä¸­æ–­å¤„ç†ï¼‰      | æ¯«ç§’çº§ï¼ˆéœ€ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°ç”¨æˆ·æ€ï¼‰                |
| â€‹**â€‹é€‚ç”¨åœºæ™¯â€‹**â€‹ | å—è®¾å¤‡é©±åŠ¨ã€å†…æ ¸ I/O æ ˆ    | æ–‡ä»¶æè¿°ç¬¦å°±ç»ªäº‹ä»¶ï¼ˆå¦‚ç½‘ç»œå¥—æ¥å­—ï¼‰              |
| â€‹**â€‹æ•°æ®å®‰å…¨â€‹**â€‹ | æ— ç”¨æˆ·æ€ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé«˜æ•ˆå®‰å…¨    | éœ€å¤„ç†ä¿¡å·ç«äº‰å’Œé‡å…¥é—®é¢˜                   |

similar to high speed networking, with high speed storage targets it can be
beneficial to use Polling instead of Waiting for Interrupts to handle request
completion æ–°æ‰‹å’Œä¸“å®¶ ç†è§£

| æ–¹é¢         | è½®è¯¢ (Polling)                          | ä¸­æ–­ (Interrupt)         |
| ---------- | ------------------------------------- | ---------------------- |
| **å»¶è¿Ÿ**     | æœ€ä½ï¼šçº³ç§’çº§å®Œæˆæ£€æµ‹                            | è¾ƒé«˜ï¼šå¾®ç§’çº§ä¸­æ–­å¼€é”€             |
| **CPU åˆ©ç”¨** | è¾ƒé«˜ï¼šæŒç»­å¿™ç­‰ä¼šå ç”¨ CPU å‘¨æœŸ                     | ä½ï¼šåªæœ‰ I/O å®Œæˆç¬é—´æ‰æ¶ˆè€—å°‘é‡ CPU |
| **åå**     | é«˜å¹¶å‘åœºæ™¯è¡¨ç°ä¼˜å¼‚ï¼ˆå‡å°‘ä¸­æ–­é£æš´ï¼‰                     | ä¸­æ–­é£æš´å¯èƒ½æˆä¸ºç“¶é¢ˆ             |
| **å¤æ‚åº¦**    | éœ€è¦ä»”ç»†è°ƒåº¦ã€çº¿ç¨‹äº²å’ŒåŠè½®è¯¢æ—¶é•¿ï¼ˆbudgetï¼‰ç®¡ç† å’Œ fallback | ç®€å•ï¼Œæ“ä½œç³»ç»Ÿè‡ªåŠ¨ç®¡ç†            |
**blkâ€‘mq çš„æ ¸å¿ƒæ€æƒ³**

- **å¤šæäº¤é˜Ÿåˆ—ï¼ˆperâ€‘CPU submit queuesï¼‰**ï¼šæ¯ä¸ª CPU æ ¸æœ‰è‡ªå·±çš„ä¸€å°é˜Ÿåˆ—ï¼Œæäº¤ I/O æ—¶å…ˆæ”¾åˆ°æœ¬æ ¸çš„é˜Ÿåˆ—é‡Œï¼Œå‡å°‘è·¨æ ¸æŠ¢é”ã€‚
    
- **å¤šç¡¬ä»¶é˜Ÿåˆ—æ˜ å°„**ï¼šå†…æ ¸å°†æ¯ä¸ª CPU çš„æäº¤é˜Ÿåˆ—å’Œå­˜å‚¨è®¾å¤‡çš„**ç¡¬ä»¶é˜Ÿåˆ—**ä¸€ä¸€å¯¹åº”ï¼ŒI/O å®Œæˆæ—¶ä¹Ÿå›åˆ°åŒä¸€ä¸ª CPU å»å¤„ç†ï¼Œä¿è¯ç¼“å­˜å±€éƒ¨æ€§ã€‚
    
- **å‡å°‘å…±äº«çŠ¶æ€**ï¼šæäº¤å’Œå®Œæˆéƒ½åœ¨æœ¬æ ¸å®Œæˆï¼Œå°½é‡ä¸åœ¨ CPU ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œé™ä½å»¶è¿Ÿå’Œé”ç«äº‰

ä¸ Linux å—å±‚çš„å…³ç³»

- **å¹¶ä¸ç»•å¼€å—å±‚**ï¼šio_uring çš„ SQE å¡«å†™åªæ˜¯å‘Šè¯‰å†…æ ¸è¦åšå“ªç§ I/Oï¼ŒçœŸæ­£çš„è¯»å†™è¿˜æ˜¯èµ° **submit_bio â†’ request â†’ è°ƒåº¦ â†’ é©±åŠ¨** çš„æ ‡å‡†å—å±‚è·¯å¾„ã€‚
    
- **å¼‚æ­¥åŒ–ï¼‹æ‰¹é‡åŒ–**ï¼šåŸæ¥åº”ç”¨æ˜¯ã€Œä¸€æ¬¡ syscall â†’ ä¸€æ¬¡ I/Oã€ï¼Œio_uring åˆ™å¯ä»¥ã€Œä¸€æ¬¡ enter æäº¤å¤šæ¡ SQE â†’ æ‰¹é‡ä¸‹å‘å¤šæ¡ bio â†’ æ‰¹é‡å›æ”¶ CQEã€ï¼Œå¤§å¤§å‡å°‘ syscalls/ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚
    
- **å¯é€‰ Direct I/O/Busyâ€‘Poll**ï¼šå¯¹äºæ”¯æŒçš„è®¾å¤‡ï¼ˆNVMeï¼‰ï¼ŒSQE å¯ä»¥å¸¦ `RWF_HIPRI` æˆ– io_uring iopoll æ ‡å¿—ï¼Œåˆ©ç”¨å—å±‚çš„ **polling** ç‰¹æ€§è¿›ä¸€æ­¥å‹ä½å»¶è¿Ÿã€‚
    

---

### å°ç»“

- **ä¸‰å¤§æ•°æ®ç»“æ„**ï¼šSQ ringã€CQ ringã€SQE arrayï¼›
    
- **æµç¨‹**ï¼šç”¨æˆ·å¡« SQE â†’ æ›´æ–° SQ â†’ å†…æ ¸å›è°ƒæ ‡å‡† syscall åç«¯ â†’ submit_bio â†’ å—å±‚è°ƒåº¦ â†’ bio_end_io â†’ å†™ CQE â†’ ç”¨æˆ·è¯» CQï¼›
    
- **å…³ç³»**ï¼šio_uring æ˜¯ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„ã€Œé«˜æ•ˆæäº¤ï¼å®Œæˆæ¡†æ¶ã€ï¼ŒçœŸæ­£çš„ç£ç›˜ I/O ä»ç”± Linux é€šç”¨å—å±‚ï¼ˆbio/request/elevator æˆ– blkâ€‘mqï¼‰å®Œæˆ
### 6. # linux ioè¿‡ç¨‹è‡ªé¡¶å‘ä¸‹åˆ†æ

- è¿›ç¨‹æ˜¯å†…æ ¸å¯¹CPUçš„æŠ½è±¡ï¼Œè™šæ‹Ÿå†…å­˜æ˜¯å¯¹ç‰©ç†å†…å­˜çš„æŠ½è±¡ï¼Œæ–‡ä»¶æ˜¯å¯¹æ‰€æœ‰IOå¯¹è±¡çš„æŠ½è±¡ï¼ˆåœ¨æœ¬æ–‡ï¼Œåˆ™ä¸»è¦æ˜¯æŒ‡å¯¹ç£ç›˜çš„æŠ½è±¡ï¼‰
- é€šç”¨å—å±‚çš„æ ¸å¿ƒâ€“bio
- æœ¬è¿›ç¨‹å†…ï¼Œfdçš„æœ€ç›´è§‚æ“ä½œæ˜¯openã€closeã€mmapã€ioctlã€pollè¿™