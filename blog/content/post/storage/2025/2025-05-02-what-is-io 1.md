---
title: IOçš„ä¸€ç”Ÿ
date: 2025-04-27
description: 
draft: false
tags:
  - CEPH
categories:
  - CEPH
---
å¤§å®¶å¥½æˆ‘æ˜¯å°ä¹‰åŒå­¦ï¼Œè¿™æ˜¯<font color="#00b050">å¤§å‚é¢è¯•æ‹†è§£â€”â€”é¡¹ç›®å®æˆ˜</font>ç³»åˆ—çš„ç¬¬<font color="#953734">6</font>ç¯‡æ–‡ç« ï¼Œ

â€èµ°æš—è·¯ã€è€•ç˜¦ç”°ã€è¿›çª„é—¨ã€è§å¾®å…‰â€ Â 
å‘Šè¯‰æˆ‘ Â é¢è¯•å…³é”®å°± æ·±å…¥ç†è§£è‡ªå·±é¡¹ç›® è¿™ä¸ªæ‰æ˜¯æœ€è€ƒå¯ŸåŸºæœ¬åŠŸçš„åœ°æ–¹ã€‚

çŸ¥è¯†åœ°å›¾ï¼šKVå­˜å‚¨å¼•æ“---IOæ ˆ

<font color="#245bdb">æœ¬æ–‡ ä¸»è¦æè¿° read/writeä¸ºä¾‹å­æ™®é€šæ–‡ä»¶ IOè¿‡ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</font>ï¼Œ

åˆ†æè¿™ä¸ªé—®é¢˜å…³é”®æ€è·¯åœ¨å“ªé‡Œï¼Ÿ


å¦‚æœæ‚¨è§‰å¾—é˜…è¯»æœ¬æ–‡å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œ
è¯·ç‚¹ä¸€ä¸‹â€œ**ç‚¹èµï¼Œè½¬å‘**â€ æŒ‰é’®ï¼Œ
æ‚¨çš„â€œ**ç‚¹èµï¼Œè½¬å‘**â€ å°†æ˜¯æˆ‘æœ€å¤§çš„å†™ä½œåŠ¨åŠ›ï¼

ä¸Šç¯‡æ–‡ç«  [æ–°ä¸€ä»£å­˜å‚¨å¼•æ“BlueStore,éœ€å››æ­¥](https://mp.weixin.qq.com/s/iIGui5RywsKC13daAogRJA) 

åœ¨åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ—¶å€™ï¼ŒCephçš„BlueStore ï¼Œ
1. å°†æ–‡ä»¶çš„æ•°æ®ç›´æ¥å†™å—è®¾å¤‡
2. å°†æ–‡ä»¶çš„å…ƒæ•°æ®å†™RocksDB
3. BlueStore IOæµç¨‹ å…ˆå†™æ•°æ®ï¼Œè¿˜æ˜¯å…ˆå†™å…ƒæ•°æ®é¡ºåºä¸åŒ ï¼Œæä¾›ä¸åŒç­–ç•¥ã€‚
4.  Ceph IO è½¯ä»¶æ ˆå¼€é”€åŸå›  **æ— å®ç°ä½äº 0.5 æ¯«ç§’çš„éšæœºè¯»å–å»¶è¿Ÿå’Œä½äº 1 æ¯«ç§’çš„éšæœºå†™å…¥å»¶è¿Ÿ**


æ™®é€šæ–‡ä»¶å†™æ˜¯å¦åŒºåˆ†å…ƒæ•°æ® å’Œ æ•°æ®ï¼Œè¿™äº›è¯·æ±‚æœ€åæ€ä¹ˆå†™å…¥ç£ç›˜ å‘¢ï¼Ÿ

å› ä¸ºå†…å®¹å¤ªå¤šï¼Œåˆ†æ‰¹æ¢³ç†ã€‚

å¤§çº²å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰ é¢„å¤‡çŸ¥è¯†ï¼š

![äº†è§£ç›®å‰æœ‰å“ªäº›æ–‡ä»¶ç³»ç»Ÿ](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502215215.png)

ï¼ˆ2ï¼‰ é€šè¿‡å·¥å…· äº†è§£IOæ ˆ
![IOæ ˆ](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502215326.png)
ï¼ˆ3ï¼‰ æ€§èƒ½ä¼˜åŒ–

![æ€§èƒ½ä¼˜åŒ–](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502232459.png)

## ä¸€.  å‡†å¤‡ç¯å¢ƒ 

###  1.1 æœºå™¨é…ç½®
âœ… è´­ä¹°2C2Gäº‘ä¸»æœº æˆæœ¬ä¸€å¹´ä¸è¶…è¿‡100å…ƒ

âœ… åˆ›å»º1Gçš„å¤§æ–‡ä»¶å……ä»£æ›¿å—è®¾å¤‡ï¼Œå› ä¸ºæ²¡æœ‰é¢å¤–çš„ç£ç›˜

ğŸ“Œ ä¾‹å­ï¼šç”¨ Loop è®¾å¤‡æ¨¡æ‹Ÿä¸€ä¸ª ext4 æ–‡ä»¶ç³»ç»Ÿ


```shell
# 1. åˆ›å»ºä¸€ä¸ª 1GB çš„æ™®é€šæ–‡ä»¶æ–‡ä»¶

dd if=/dev/zero of=/root/temp/virtual_disk.img bs=1M count=1024

# 2. ç»‘å®šåˆ° Loop è®¾å¤‡ï¼ˆè®© Linux è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªç£ç›˜ï¼‰

losetup /dev/loop0 /root/temp/virtual_disk.img

ls -l /dev/loop0

brw-rw---- 1 root disk 7, 0 3æœˆÂ  24 13:51 /dev/loop0ã€‚


b è¡¨ç¤ºå—è®¾å¤‡æ–‡ä»¶ï¼Œ

s è¡¨ç¤ºå¥—æ¥å­— socket æ–‡ä»¶ï¼Œ

l è¡¨ç¤ºç¬¦å·é“¾æ¥

# 3. åœ¨ /dev/loop0 ä¸Šåˆ›å»º ext4 æ–‡ä»¶ç³»ç»Ÿ

mkfs.ext4 /dev/loop0


# 4. æŒ‚è½½åˆ° /mnt ç›®å½•

mkdir /mnt/icfs

		mount  /dev/loop0 /mnt/icfs  #/ordered
		
mount -o nodelallocï¼Œdata=writeback /dev/loop0 /mnt/icfs 


## æ—¥è®°(journal)ã€ é¡ºåº(ordered)å’Œ å›å†™(writeback)
##  ext4æŒ‚è½½å‚æ•°ï¼šdelallocExt4æ–‡ä»¶ç³»ç»Ÿçš„ä¸€ä¸ªæ–°ç‰¹æ€§â€”â€”Delay Allocation ç¦ç”¨

# 5. å¦‚ä½•æŸ¥çœ‹å½“å‰çš„æ—¥å¿—æ¨¡å¼

5 1 é€šè¿‡dmesgå‘½ä»¤æŸ¥çœ‹Linuxç³»ç»Ÿçš„å†…æ ¸æ—¥å¿—

dmesg | grepÂ  "mounted filesystem"
EXT4-fs (vda1): mounted filesystem with ordered data mode. Opts: (null)


5.2 ç°ç£ç›˜çš„æ°¸ä¹…æŒ‚è½½  å¼€æœºå¯åŠ¨ /etc/fstab file æ£€æŸ¥

 /dev/loop0  /mnt/icfs  ext4 data=writeback 0 0

5.3  has_journal
 
dumpe2fs /dev/vda1 >1

Filesystem features:Â  Â  Â  
1 has_journal 
2 ext_attr 
3 resize_inode 
4 dir_index filetype needs_recovery extent 64bit flex_bg sparse_super large_file huge_file dir_nlink extra_isize metadata_csum


1. æŸ¥çœ‹IOè°ƒåº¦å™¨

cat /sys/block/loop0/queue/scheduler
[mq-deadline] 
kyber 

bfq ï¼š
â€‹ç‰¹æ€§â€‹â€‹ï¼š
æŒ‰è¿›ç¨‹åˆ†é… I/O å¸¦å®½ï¼Œä¿éšœå¤šä»»åŠ¡å…¬å¹³æ€§
å®Œå…¨å…¬å¹³é˜Ÿåˆ—è°ƒåº¦å™¨

none 
ç‰¹æ€§â€‹â€‹ï¼šæ— è°ƒåº¦ç­–ç•¥ï¼Œç›´æ¥ä¼ é€’è¯·æ±‚åˆ°ç¡¬ä»¶å±‚
é€‚ç”¨åœºæ™¯â€‹ï¼šé«˜é€Ÿå­˜å‚¨è®¾å¤‡ï¼ˆå¦‚ NVMe SSDï¼‰æˆ–å·²ç”±å®¿ä¸»æœºç®¡ç† I/O çš„è™šæ‹ŸåŒ–ç¯å¢ƒ

```


åˆ’é‡ç‚¹ï¼šå‚æ•°å«ä¹‰è¯´æ˜

æ–‡ä»¶ç³»ç»Ÿæ”¯æŒçš„ä¸‰ç§æ—¥å¿—æ¨¡å¼ æ˜¯ä»€ä¹ˆ
- ext4æŒ‚è½½å‚æ•°: data

| Journalâ€‹**â€‹ç‰¹æ€§â€‹**â€‹ | Journal     | Orderedï¼ˆé»˜è®¤ï¼‰ | Writeback |
| ----------------- | ----------- | ----------- | --------- |
| â€‹**â€‹æ•°æ®è®°å½•â€‹**â€‹      | å…ƒæ•°æ®+æ•°æ®å‡è®°å½•æ—¥å¿— | ä»…å…ƒæ•°æ®æ—¥å¿—      | ä»…å…ƒæ•°æ®æ—¥å¿—    |
| â€‹**â€‹æ•°æ®å†™å…¥é¡ºåºâ€‹**â€‹    | ä¸¥æ ¼åŒæ­¥        | æ•°æ®å…ˆäºå…ƒæ•°æ®å†™å…¥   | æ— å¼ºåˆ¶é¡ºåº     |
| â€‹**â€‹æ€§èƒ½â€‹**â€‹        | æœ€ä½          | ä¸­ç­‰          | æœ€é«˜        |
| â€‹**â€‹å´©æºƒæ¢å¤â€‹**â€‹      | å®Œå…¨ä¸€è‡´        | æ•°æ®å¯èƒ½éƒ¨åˆ†ä¸¢å¤±    | æ•°æ®å¯èƒ½å¤§é‡ä¸¢å¤±  |
| â€‹**â€‹å…¸å‹åœºæ™¯â€‹**â€‹      | æ•°æ®åº“ã€å…³é”®ä¸šåŠ¡    | æœåŠ¡å™¨ã€æ—¥å¸¸åŠå…¬    | é«˜æ€§èƒ½è®¡ç®—     |
 
- IfÂ `data=writeback`, dirty data blocks are not flushed to the disk before the metadata are written to disk through the journal.
- å†…æ ¸æœ‰ä¸“é—¨çš„æœºåˆ¶è´Ÿè´£å°†é¡µç¼“å­˜ä¸­çš„æ•°æ®**å¼‚æ­¥åœ°**å†™å…¥ç£ç›˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º**å†™å›ï¼ˆwritebackï¼‰**ã€‚

| å»¶è¿Ÿåˆ†é…â€‹**â€‹åœºæ™¯â€‹**â€‹   | â€‹**â€‹æ¨èé€‰é¡¹â€‹**â€‹ | â€‹**â€‹åŸå› â€‹**â€‹                           |
| ---------------- | ------------ | ------------------------------------ |
| â€‹**â€‹é«˜ååé‡é¡ºåºå†™å…¥â€‹**â€‹ | `delalloc`   | åˆ©ç”¨æ‰¹é‡åˆ†é…ä¼˜åŒ–è¿ç»­å†™å…¥æ€§èƒ½ï¼ˆå¦‚æ—¥å¿—æœåŠ¡å™¨ã€å¤§æ•°æ®å¤„ç†ï¼‰<br><br> |
| â€‹**â€‹ä½å»¶è¿Ÿå…³é”®ä¸šåŠ¡â€‹**â€‹  | `nodelalloc` | é¿å…å•æ¬¡å†™å…¥å»¶è¿Ÿæ³¢åŠ¨ï¼ˆå¦‚æ•°æ®åº“äº‹åŠ¡ã€å®æ—¶ç³»ç»Ÿï¼‰<br>          |

### 2.1 å—è®¾å¤‡IOè·Ÿè¸ª

```c
#Â å®‰è£…blktraceåŒ…
sudo yum install blktrace

# blktraceåŒ…å®‰è£…åæœ‰blktraceã€blkparseã€bttã€blkiomonè¿™4ä¸ªå‘½ä»¤
#blktraceè´Ÿè´£é‡‡é›†I/Oäº‹ä»¶æ•°æ®ï¼Œ
# blkparseè´Ÿè´£å°†æ¯ä¸€ä¸ªI/Oäº‹ä»¶æ•°æ®è§£æä¸ºçº¯æ–‡æœ¬æ–¹ä¾¿é˜…è¯»ï¼Œ
## bttã€blkiomonè´Ÿè´£ç»Ÿè®¡åˆ†æ

#Â blktraceä¾èµ–debugfsï¼Œéœ€è¦æŒ‚è½½å®ƒ  
sudo mount -t debugfs none /sys/kernel/debug
## debugfs æ˜¯ Linux å†…æ ¸æä¾›çš„ä¸€ä¸ªä¸“ç”¨æ–‡ä»¶ç³»ç»Ÿï¼ŒåŠ¨æ€åˆ›å»ºã€æ— éœ€é‡æ–°ç¼–è¯‘å†…æ ¸
éªŒè¯
lsÂ /sys/kernel/debug/
mount | grep debugfsÂ 

debugfs on /sys/kernel/debug type debugfs (rw,relatime)

dd if=/dev/zero of=/mnt/icfs/test bs=1k count=16

blktrace -d /dev/loop0 -o - |blkparse -i -


```


ä¸€ã€å­—æ®µå«ä¹‰ä¸äº‹ä»¶é“¾åˆ†æ
1. â€‹**â€‹å­—æ®µè§£æâ€‹**â€‹ï¼ˆå‚è€ƒç¤ºä¾‹è¡Œï¼š`7,0 1 226 52.043115656 3815652 Q WS 1104864 +8 [jbd2/loop0-8]`ï¼‰
    - â€‹**â€‹7,0â€‹**â€‹ï¼šè®¾å¤‡å·ï¼ˆä¸»è®¾å¤‡å·:æ¬¡è®¾å¤‡å·ï¼‰ï¼Œè¡¨ç¤ºÂ `/dev/loop0`ï¼ˆè™šæ‹Ÿå—è®¾å¤‡ï¼‰ã€‚
    - â€‹**â€‹1â€‹**â€‹ï¼šCPU æ ¸ç¼–å·ï¼ˆæ­¤å¤„ä¸º CPU 1ï¼‰ã€‚
    - â€‹**â€‹226â€‹**â€‹ï¼šäº‹ä»¶åºåˆ—å·ã€‚
    - â€‹**â€‹52.043115656â€‹**â€‹ï¼šæ—¶é—´æˆ³ï¼ˆç§’çº§ç²¾åº¦ï¼‰ã€‚
    - â€‹**â€‹3815652â€‹**â€‹ï¼šè¿›ç¨‹ PIDï¼ˆjbd2 å†…æ ¸çº¿ç¨‹ï¼‰ã€‚
    - â€‹**â€‹Q/WSâ€‹**â€‹ï¼šäº‹ä»¶ç±»å‹ï¼ˆQ=è¯·æ±‚è¿›å…¥é˜Ÿåˆ—ï¼ŒWS=å†™åŒæ­¥æ“ä½œï¼‰ã€‚
    - â€‹**â€‹1104864 +8â€‹**â€‹ï¼šèµ·å§‹å—å·Â `1104864`ï¼Œæ“ä½œå¤§å°Â `8`Â ä¸ªå—ï¼ˆé€šå¸¸ 1 å—=4KBï¼Œå³ 32KB å†™æ“ä½œï¼‰ã€‚
    - â€‹**â€‹[jbd2/loop0-8]â€‹**â€‹ï¼šè¿›ç¨‹åï¼Œè¡¨ç¤ºÂ `jbd2`Â çº¿ç¨‹ç®¡ç†Â `/dev/loop0`Â è®¾å¤‡çš„æ—¥å¿—åŠŸèƒ½ã€‚
2. â€‹**â€‹äº‹ä»¶é“¾åˆ†æâ€‹**â€‹ï¼ˆå…³é”®é˜¶æ®µï¼‰
    - â€‹**â€‹Qâ†’G é˜¶æ®µâ€‹**â€‹ï¼ˆè¯·æ±‚ç”Ÿæˆï¼‰ï¼š  
        ç¤ºä¾‹ï¼š`Q WS 1104864 +8`Â â†’Â `G WS 1104864 +8`  
        è¡¨ç¤º I/O è¯·æ±‚è¿›å…¥å—å±‚ååˆ†é…Â `request`Â ç»“æ„ä½“ï¼ˆè€—æ—¶çº¦å¾®ç§’çº§ï¼‰ã€‚
    - â€‹**â€‹I é˜¶æ®µâ€‹**â€‹ï¼ˆæ’å…¥è°ƒåº¦å™¨é˜Ÿåˆ—ï¼‰ï¼š  
        å¤šè¡ŒÂ `I WS`Â äº‹ä»¶æ˜¾ç¤ºè¯·æ±‚è¢«æ’å…¥ I/O è°ƒåº¦å™¨é˜Ÿåˆ—ï¼ˆå¦‚Â `mq-deadline`ï¼‰ã€‚
    - â€‹**â€‹D é˜¶æ®µâ€‹**â€‹ï¼ˆä¸‹å‘åˆ°é©±åŠ¨ï¼‰ï¼š  
        `D WS`Â è¡¨ç¤ºè¯·æ±‚è¢«å‘é€è‡³è®¾å¤‡é©±åŠ¨å±‚ï¼Œè¿›å…¥ç‰©ç†è®¾å¤‡å¤„ç†ã€‚
    - â€‹**â€‹U/FN é˜¶æ®µâ€‹**â€‹ï¼š  
        `U N`Â è¡¨ç¤ºé˜Ÿåˆ—è§£ç»‘æ“ä½œï¼›`D FN`Â å¯èƒ½æ¶‰åŠå±éšœï¼ˆBarrierï¼‰æˆ–åˆ·æ–°æ“ä½œã€‚


```shell
  
jbd2 è¿›ç¨‹è´Ÿè´£ ext4 æ–‡ä»¶ç³»ç»Ÿçš„æ—¥å¿—æäº¤æ“ä½œã€‚

echo 1 > /sys/kernel/debug/tracing/events/ext4/ext4_sync_file_enter/enable
echo 1 > /sys/kernel/debug/tracing/events/jbd2/jbd2_commit_flushing/enable

Â Â  Â  barad_agent-621691Â  [000] .... 16365334.481433: ext4_sync_file_enter: dev 253,1 ino 922856 parent 927477 datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  [000] .... 16365334.482411: jbd2_commit_flushing: dev 253,1 transaction 23610801 sync 0

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.485209: ext4_sync_file_enter: dev 253,1 ino 922856 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.485976: ext4_sync_file_enter: dev 253,1 ino 923617 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.488730: ext4_sync_file_enter: dev 253,1 ino 928166 parent 927477 datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  [001] .... 16365334.489345: jbd2_commit_flushing: dev 253,1 transaction 23610802 sync 0

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.492786: ext4_sync_file_enter: dev 253,1 ino 928166 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.493294: ext4_sync_file_enter: dev 253,1 ino 923617 parent 927477 datasync 1Â 

Â Â  Â  barad_agent-621691Â  [001] .... 16365334.494829: ext4_sync_file_enter: dev 253,1 ino 922856 parent 927477 datasync 1Â 

Â Â  Â  jbd2/vda1-8-367 Â  Â  [000] .... 16365334.495552: jbd2_commit_flushing: dev 2


strace -c -f -e trace=file,sync,fsync,fdatasync -p 20949

jbd2 çº¿ç¨‹ä¸ Linux é€šç”¨å—å±‚ç´§å¯†åä½œï¼š
ä»æ„é€  BIOã€

è°ƒç”¨ `submit_bio()`ã€

ä¾èµ–å—å±‚çš„åˆå¹¶ä¸è°ƒåº¦ï¼Œ
åˆ°æ¥æ”¶ `bio_end_io` å›è°ƒï¼Œ

å½¢æˆäº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„ã€å…·å¤‡é«˜ä¼˜å…ˆçº§ä¿éšœçš„æ—¥å¿—å†™å…¥é€šé“ï¼Œ
ç¡®ä¿ ext4/ext3 æ–‡ä»¶ç³»ç»Ÿåœ¨å´©æºƒæ¢å¤æ—¶èƒ½å¤Ÿå¿«é€Ÿä¸”å¯é åœ°å›æ”¾ä¸æäº¤äº‹åŠ¡ã€‚

```
### 2.3ä»å—å±‚é¢ IOä¼˜åŒ–



## äºŒ.  IOæ ˆå…¨æ™¯å›¾

- https://www.thomas-krenn.com/de/wikiDE/images/e/e8/Linux-storage-stack-diagram_v6.9.png

![image.png](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502165459.png)


ä¸ºäº†æŒæ¡IOæ ˆå¿…é¡»äº†è§£çš„åŸºæœ¬çŸ¥è¯†

- ä»€ä¹ˆæ˜¯è™šæ‹Ÿå†…å­˜ï¼Œä¸ç£ç›˜æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ è¿™ä¸ªæ˜¯äº†è§£ å—è®¾å¤‡bioå±‚åŸºç¡€

![â€”ä¸ª VM ç³»ç»Ÿæ˜¯å¦‚ä½•ä½¿ç”¨ä¸»å­˜ä½œä¸ºç¼“å­˜](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502163052.png)
å®ƒå°†ä¸»å­˜çœ‹æˆæ˜¯ä¸€ä¸ªå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„åœ°å€ç©ºé—´çš„ é«˜é€Ÿç¼“å­˜ï¼Œ
åœ¨ä¸»å­˜ä¸­åªä¿å­˜æ´»åŠ¨åŒºåŸŸï¼Œ
å¹¶æ ¹æ®éœ€è¦åœ¨ç£ç›˜å’Œä¸»å­˜ä¹‹é—´æ¥å›ä¼ é€æ•°æ®ï¼Œ
é€šè¿‡ è¿™ç§æ–¹å¼ï¼Œå®ƒé«˜æ•ˆåœ°ä½¿ç”¨äº†ä¸»å­˜

åœ¨ä»»æ„æ—¶åˆ»ï¼Œè™šæ‹Ÿé¡µé¢çš„é›†åˆéƒ½åˆ†ä¸ºä¸‰ä¸ªä¸ç›¸äº¤çš„å­é›†ï¼š
â€¢æœªåˆ†é…çš„ï¼šVM ç³»ç»Ÿè¿˜æœªåˆ†é…(æˆ–è€…åˆ›å»ºï¼‰çš„é¡µã€‚
æœªåˆ†é…çš„å—æ²¡æœ‰ä»»ä½•æ•°æ®å’Œå®ƒä»¬ç›¸ å…³è”ï¼Œå› æ­¤ä¹Ÿå°±ä¸å ç”¨ä»»ä½•ç£ç›˜ç©ºé—´ã€‚ 
â€¢ç¼“å­˜çš„ï¼šå½“å‰å·²ç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µã€‚
â€¢æœªç¼“å­˜çš„ï¼šæœªç¼“å­˜åœ¨ç‰©ç†å†…å­˜ä¸­çš„å·²åˆ†é…é¡µ

- åœ°å€ç©ºé—´ï¼ˆaddress space)æ˜¯ä¸€ä¸ªéè´Ÿæ•´æ•°åœ°å€çš„æœ‰åºé›†åˆã€åœ°å€å’Œæ•°æ®å…³ç³»ã€‘
- â€”ä¸ª VM ç³»ç»Ÿæ˜¯å¦‚ä½•ä½¿ç”¨ä¸»å­˜ä½œä¸ºç¼“å­˜
- åœ¨è™šæ‹Ÿå†…å­˜çš„ä¹ æƒ¯è¯´æ³•ä¸­ï¼ŒDRAM ç¼“å­˜ä¸å‘½ä¸­ç§°ä¸ºç¼ºé¡µï¼ˆpage fault)
- åœ¨ç£ç›˜å’Œå†…å­˜ä¹‹é—´ä¼ é€é¡µçš„æ´» åŠ¨å«åšäº¤æ¢ï¼ˆswapping)æˆ–è€…é¡µ é¢è°ƒåº¦ï¼ˆpaging)ã€‚é¡µä»ç£ç›˜æ¢å…¥ï¼ˆæˆ–è€…é¡µé¢è°ƒå…¥ï¼‰DRAM å’Œä» DRAM æ¢å‡ºï¼ˆæˆ–è€…é¡µé¢è°ƒå‡ºï¼‰ç£ç›˜ã€‚

- ![Linux kernel Block I/O Layer](https://money-1256465252.cos.ap-beijing.myqcloud.com/mac/20250502174539.png)


## ä¸‰ã€IOæ€§èƒ½ä¼˜åŒ–é‡‡ç”¨æ‰‹æ®µ



### å‚è€ƒç¬¬ä¸€æ‰‹èµ„æ–™
### [1] Introduction to Perf
 - https://www.slideshare.net/slideshow/introduction-to-perf/59077668


### [2 ] etcd åœ¨è¶…å¤§è§„æ¨¡æ•°æ®åœºæ™¯ä¸‹çš„æ€§èƒ½ä¼˜åŒ–
-  è‹±æ–‡ï¼šhttps://www.cncf.io/blog/2019/05/09/performance-optimization-of-etcd-in-web-scale-data-scenario/
- æ‘˜è¦ï¼šå½“ etcd å­˜å‚¨æ•°æ®é‡è¶…è¿‡ 40GB åï¼Œç»è¿‡ä¸€æ¬¡ compact(compact æ˜¯ etcd å°†ä¸éœ€è¦çš„å†å²ç‰ˆæœ¬æ•°æ®åˆ é™¤çš„æ“ä½œ)åå‘ç° put æ“ä½œçš„å»¶æ—¶æ¿€å¢
- etcd å­˜å‚¨å±‚å¯ä»¥çœ‹æˆç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€å±‚åœ¨å†…å­˜ä¸­çš„åŸºäº btree çš„ç´¢å¼•å±‚ï¼Œä¸€å±‚åŸºäº boltdb çš„ç£ç›˜å­˜å‚¨å±‚ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹ä»‹ç»åº•å±‚ boltdb å±‚ï¼Œå› ä¸ºå’Œæœ¬æ¬¡ä¼˜åŒ–ç›¸å…³
- https://www.qiyacloud.cn/2021/10/2021-10-08/
- https://www.qiyacloud.cn/2021/10/2021-10-21/
-  ç”±ä¸€æ¬¡ slow-request æµ…è°ˆ Ceph scrub åŸç† 
- https://www.infoq.cn/article/Z9m5xkLYPlp95wyFtksm
- å¯ä»¥çœ‹åˆ°rocksdbæ­£åœ¨è¿›è¡Œcompactingï¼Œè¯´æ˜ä¸šåŠ¡å†™è¯·æ±‚æ¯”è¾ƒå¤šã€‚
æ‰€ä»¥å¯ç¡®å®šæœ¬æ¬¡slow-requestçš„åŸå› ï¼šå¤§é‡çš„ç”¨æˆ·å†™å…¥æ“ä½œå¯¼è‡´rocksdbè¿›è¡Œcompactingï¼ŒåŠ ä¸Šdeep-scrubè¿›ä¸€æ­¥å¼•å‘åº•å±‚IOèµ„æºçš„ç«äº‰ï¼Œæœ€ç»ˆå¯¼è‡´ç”¨æˆ·è¯·æ±‚è¶…æ—¶

#### 3. **CRUSH å¦‚ä½•å®ç°å‡åŒ€åˆ†å¸ƒ**
- CRUSH ç®—æ³•èƒ½å¤Ÿå¿«é€Ÿå®šä½å­˜å‚¨è®¾å¤‡å¯¹åº”çš„å¯¹è±¡ï¼Œå¹¶æ ¹æ®è§„åˆ™é€‰æ‹©ä¸€ä¸ªæ–°çš„å­˜å‚¨è®¾å¤‡æ¥å­˜å‚¨å¯¹è±¡ï¼Œå®ç°æ•°æ®çš„è‡ªåŠ¨æ¢å¤å’Œé‡æ–°åˆ†å¸ƒã€‚ä¾‹å¦‚ï¼Œå½“æŸä¸ª OSD å‡ºç°æ•…éšœæ—¶ï¼ŒCRUSH ç®—æ³•ä¼šé‡æ–°è®¡ç®—æ•°æ®çš„å­˜å‚¨ä½ç½®ï¼Œå°†åŸæœ¬å­˜å‚¨åœ¨æ•…éšœ OSD ä¸Šçš„æ•°æ®è¿ç§»åˆ°å…¶ä»–æ­£å¸¸çš„ OSD ä¸Šï¼Œç¡®ä¿æ•°æ®çš„é«˜å¯ç”¨æ€§ã€‚åŒæ—¶ï¼ŒCRUSH ç®—æ³•è¿˜èƒ½å¤Ÿæ ¹æ®é›†ç¾¤çš„è´Ÿè½½æƒ…å†µï¼ŒåŠ¨æ€åœ°è°ƒæ•´æ•°æ®çš„åˆ†å¸ƒï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼Œæé«˜é›†ç¾¤çš„æ•´ä½“æ€§èƒ½ã€‚
- https://www.clyso.com/us/data-distribution-in-ceph-understanding-the-crush-algorithm/
- https://www.clyso.com/us/pushing-ceph-rados-into-new-frontiers-lets-make-the-linux-of-storage-a-reality/
- **æ¡¶ï¼ˆBucketsï¼‰**ï¼š
- ç”¨äºè¡¨ç¤ºé›†ç¾¤çš„å±‚çº§ç»“æ„ï¼Œä¾‹å¦‚æ•°æ®ä¸­å¿ƒã€æœºæˆ¿ã€æœºæ¶ã€ä¸»æœºç­‰ã€‚æ¡¶å¯ä»¥åµŒå¥—ï¼Œå½¢æˆæ ‘çŠ¶ç»“æ„ã€‚æ¯ä¸ªæ¡¶åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå­æ¡¶æˆ–è®¾å¤‡ã€‚
- https://ceph.com/assets/pdfs/weil-crush-sc06.pdf

ä¸ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashingï¼‰çš„åŒºåˆ«

| ç‰¹æ€§       | CRUSH                       | ä¸€è‡´æ€§å“ˆå¸Œ               |
| -------- | --------------------------- | ------------------- |
| **æ‹“æ‰‘æ„ŸçŸ¥** | æ”¯æŒå¤šå±‚çº§æ•…éšœåŸŸï¼ˆæœºæ¶ã€æœºæˆ¿ç­‰ï¼‰ï¼Œç¡®ä¿å‰¯æœ¬åœ¨ä¸åŒåŸŸåˆ†å¸ƒ | é€šå¸¸åªåœ¨é€»è¾‘ç¯ä¸Šåˆ†å¸ƒï¼Œä¸å…³å¿ƒç‰©ç†æ‹“æ‰‘  |



#### ã€4ã€‘ ceph
- Accelerating Ceph with RDMA and NVMe-oF 
- https://www.openfabrics.org/images/2018workshop/presentations/206_HTang_AcceleratingCephRDMANVMe-oF.pdf
- https://www.youtube.com/watch?v=Mb816kz27mY
	- https://ceph.io/en/news/blog/2022/ceph-osd-cpu-scaling/
-  è‡ªæ—‹é”çš„é«˜æ˜‚æˆæœ¬
åœ¨é«˜ IOPS åœºæ™¯ä¸‹ï¼Œspinlock ä¼šåœ¨çŸ­æ—¶é—´å†…ä¸æ–­å¾ªç¯å°è¯•è·å–é”è€Œä¸è¿›è¡Œä¼‘çœ ï¼Œè¿™ç§â€œå¿™ç­‰â€æ–¹å¼ä¼šå ç”¨å¤§é‡ CPU å‘¨æœŸå´æ— æ³•åšæœ‰æ•ˆå·¥ä½œï¼Œè¡¨ç°ä¸º CPU ä½¿ç”¨ç‡é£™é«˜ä½†ååå¹¶æœªæå‡
- AsyncMessenger::AsyncMessenger(
```

Messenger *ms_cluster = Messenger::create(g_ceph_context, cluster_msg_type,

entity_name_t::OSD(whoami), "cluster", nonce);

AsyncMessenger::AsyncMessenger(CephContext *cct, entity_name_t name,

const std::string &type, std::string mname, uint64_t _nonce)

: SimplePolicyMessenger(cct, name),

dispatch_queue(cct, this, mname),

nonce(_nonce)

{

std::string transport_type = "posix";

if (type.find("rdma") != std::string::npos)

transport_type = "rdma";

else if (type.find("dpdk") != std::string::npos)

transport_type = "dpdk"


```


- # BlueStore: a new, faster storage backend for Ceph
- https://events.static.linuxfound.org/sites/events/files/slides/20170323%20bluestore.pdf
- https://github.com/c-rainstorm/blog/blob/master/os/FileSystem-Ext4.md è¿™ä¸ªæ–‡ç« æ²¡è¯´journalè®©é™·å…¥è¯¯å¯¼ï¼Œæ³¨æ„åŒºåˆ†
- https://events.static.linuxfound.org/sites/events/files/slides/20170323%20bluestore.pdf ã€ååé¢å¤šçœ‹å‡ æ¬¡ã€‘
ä¸€ã€â€‹**â€‹æ ¸å¿ƒç—›ç‚¹ï¼šLSM-Treeæ¶æ„çš„å›ºæœ‰ç¼ºé™·â€‹**â€‹
ä¸ç†è§£åœ°æ–¹ï¼šâ— Many deferred write keys end up in L0
1. â€‹**â€‹Compactionä¼˜å…ˆçº§æ§åˆ¶å›°éš¾â€‹**â€‹
    - â€‹**â€‹é—®é¢˜æœ¬è´¨â€‹**â€‹ï¼šRocksDBåŸºäºLSM-Treeï¼ˆLog-Structured Merge Treeï¼‰è®¾è®¡ï¼Œæ•°æ®é€šè¿‡é€å±‚åˆå¹¶ï¼ˆCompactionï¼‰å®ç°æœ‰åºåŒ–ã€‚ä½†â€‹**â€‹ä¸åŒå±‚çº§ï¼ˆL0-Lmaxï¼‰çš„Compactionä¼˜å…ˆçº§æ— æ³•ç²¾ç»†æ§åˆ¶â€‹**â€‹ï¼Œå¯¼è‡´é«˜ä¼˜å…ˆçº§ä¸šåŠ¡æ•°æ®ï¼ˆå¦‚å…ƒæ•°æ®ï¼‰å¯èƒ½è¢«ä½ä¼˜å…ˆçº§æ•°æ®é˜»å¡ã€‚
    - â€‹**â€‹å…¸å‹æ¡ˆä¾‹â€‹**â€‹ï¼šå…ƒæ•°æ®ï¼ˆå¦‚Bluestoreçš„`onode`ï¼‰å†™å…¥åé¢‘ç¹è§¦å‘L0â†’L1 Compactionï¼Œè€Œç”¨æˆ·æ•°æ®CompactionæŠ¢å èµ„æºï¼Œå¯¼è‡´å…ƒæ•°æ®è®¿é—®å»¶è¿ŸæŠ–åŠ¨ã€‚
2. â€‹**â€‹å…ƒæ•°æ®æ€»é‡å¢é•¿å¼•å‘æ€§èƒ½åŠ£åŒ–â€‹**â€‹
    
    - â€‹**â€‹é›ªå´©æ•ˆåº”â€‹**â€‹ï¼šéšç€å…ƒæ•°æ®è§„æ¨¡å¢é•¿ï¼ˆå¦‚Cephé›†ç¾¤ä¸­æ•°åäº¿å¯¹è±¡ï¼‰ï¼ŒCompactionæ“ä½œæ‰€éœ€å†…å­˜ã€CPUã€IOèµ„æºå‘ˆéçº¿æ€§ä¸Šå‡ã€‚
    - â€‹**â€‹æ•°æ®ä½è¯â€‹**â€‹ï¼šå½“å…ƒæ•°æ®æ€»é‡è¶…è¿‡Block Cacheå®¹é‡æ—¶ï¼ŒRange Queryï¼ˆèŒƒå›´æŸ¥è¯¢ï¼‰å› ç¼“å­˜å¤±æ•ˆè¢«è¿«è§¦å‘ç£ç›˜IOï¼Œååé‡ä¸‹é™50%+
    - https://www.slideshare.net/Inktank_Ceph/ceph-day-shanghai-ceph-performance-tools?from_search=7# Ceph Day Shanghai - Ceph Performance Tools ã€äº†è§£å‡ ä¸ªå‘½ä»¤ ã€‘
    - https://www.youtube.com/playlist?list=PLrBUGiINAakNgeLvjald7NcWps_yDCblr


